<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Distributed architectures for big data processing and analytics - 25&nbsp; Graph Analytics in Spark</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./21_streaming_analytics.html" rel="next">
<link href="./19_graph_analytics_1.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./20_graph_analytics_2.html"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Graph Analytics in Spark</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Distributed architectures for big data processing and analytics</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">About this Book</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_01_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to Big data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_architectures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Big data architectures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03b_HDFS_clc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">HDFS and Hadoop: command line commands</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_intro_hadoop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Introduction to Hadoop and MapReduce</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_hadoop_implementation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">How to write MapReduce programs in Hadoop</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_mapreduce_patterns_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">MapReduce patterns - 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_mapreduce_advanced_topics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">MapReduce and Hadoop Advanced Topics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_mapreduce_patterns_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">MapReduce patterns - 2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_sql_operators_mapreduce.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Relational Algebra Operations and MapReduce</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10b_spark_submit_execute.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">How to submit/execute a Spark application</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_intro_spark.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Introduction to Spark</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_rdd_based_programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">RDD based programming</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_rdd_keyvalue_pairs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">RDDs and key-value pairs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_rdd_numbers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">RDD of numbers</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_cache_accumulators_broadcast.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Cache, Accumulators, Broadcast Variables</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15b_pagerank.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Introduction to PageRank</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_sparksql_dataframes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Spark SQL and DataFrames</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18a_spark_mllib.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Spark MLlib</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18b_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Classification algorithms</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18c_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Clustering algorithms</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18d_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Regression algorithms</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18e_mining.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Itemset and Association rule mining</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19_graph_analytics_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Graph analytics in Spark</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_graph_analytics_2.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Graph Analytics in Spark</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_streaming_analytics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Streaming data analytics frameworks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_structured_streaming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Spark structured streaming</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_streaming_frameworks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Streaming data analytics frameworks</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#algorithms-over-graphs" id="toc-algorithms-over-graphs" class="nav-link active" data-scroll-target="#algorithms-over-graphs">Algorithms over graphs</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Graph Analytics in Spark</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="algorithms-over-graphs" class="level3">
<h3 class="anchored" data-anchor-id="algorithms-over-graphs">Algorithms over graphs</h3>
<p>GraphFrame provides the parallel implementation of a set of state of the art algorithms for graph analytics</p>
<ul>
<li>Breadth first search</li>
<li>Shortest paths</li>
<li>Connected components</li>
<li>Strongly connected component</li>
<li>Label propagation</li>
<li>PageRank</li>
<li>…</li>
</ul>
<p>Also custom algorithms can be designed and implemented.</p>
<section id="checkpoint-directory" class="level4">
<h4 class="anchored" data-anchor-id="checkpoint-directory">Checkpoint directory</h4>
<p>To run some expensive algorithms, set a checkpoint directory that will store the state of the job at every iteration. This allows to continue where left off if the job crashes. Create such a folder to set the checkpoint directory with:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a>sc.setCheckpointDir(graphframes_ckpts_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>graphframes_ckpts_dir</code> is the new checkpoint folder directory</li>
<li><code>sc</code> is the SparkContext object (retrieve it from a SparkSession by using <code>spark.sparkContext</code>)</li>
</ul>
</section>
<section id="breadth-first-search" class="level4">
<h4 class="anchored" data-anchor-id="breadth-first-search">Breadth first search</h4>
<p>Breadth-first search (BFS) is an algorithm for traversing/searching graph data structures: it finds the shortest path(s) from one vertex (or a set of vertexes)to another vertex (or a set of vertexes). It is used in many other algorithms</p>
<ul>
<li>Length of shortest paths</li>
<li>Connected components</li>
<li>…</li>
</ul>
<section id="implementation" class="level5">
<h5 class="anchored" data-anchor-id="implementation">Implementation</h5>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>bfs(fromExpr, toExpr, edgeFilter<span class="op">=</span><span class="va">None</span> maxPathLength<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>bfs()</code> method of the GraphFrame class returns the shortest path(s) from the vertexes matching expression <code>fromExpr</code> expression to vertexes matching expression <code>toExpr</code>. If there are many vertexes matching <code>fromExpr</code> and <code>toExpr</code>, only the couple(s) with the shortest length is returned.</p>
<ul>
<li><code>fromExpr</code>: Spark SQL expression specifying valid starting vertexes for the execution of the BFS algorithm (e.g., to start from a specific vertex: “id = [start vertex id]”);</li>
<li><code>toExpr</code>: Spark SQL expression specifying valid target vertexes for the BFS algorithm;</li>
<li><code>maxPathLength</code>: Limit on the length of paths (default = 10);</li>
<li><code>edgeFilter</code>: Spark SQL expression specifying edges that may be used in the search (default None).</li>
</ul>
<p><code>bfs()</code> returns a DataFrame containing the selected shortest path(s). Notice that ff multiple paths are valid and their length is equal to the shortest length, the returned DataFrame will contain one Row for each path. The number of columns of the returned DataFrame is equal to <span class="math inline">\((\text{length of the shortest path}*2).+1\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example 1
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li>Find the shortest path from Esther to Charlie</li>
<li>Store the result in a DataFrame</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Example graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Resulting graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_2.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>The content of the returned DataFrame is the following</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>from</th>
<th><span class="math inline">\(e0\)</span></th>
<th><span class="math inline">\(v1\)</span></th>
<th><span class="math inline">\(e1\)</span></th>
<th>to</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\([u5, \text{Esther}, 32]\)</span></td>
<td><span class="math inline">\([u5, u6, \text{follow}]\)</span></td>
<td><span class="math inline">\([u6, \text{Fanny}, 36]\)</span></td>
<td><span class="math inline">\([u6, u3, \text{follow}]\)</span></td>
<td><span class="math inline">\([u3, \text{Charlie}, 30]\)</span></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb3-5"><a href="#cb3-5"></a>    [</span>
<span id="cb3-6"><a href="#cb3-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb3-7"><a href="#cb3-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb3-8"><a href="#cb3-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb3-9"><a href="#cb3-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb3-10"><a href="#cb3-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb3-11"><a href="#cb3-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb3-12"><a href="#cb3-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb3-13"><a href="#cb3-13"></a>    ],</span>
<span id="cb3-14"><a href="#cb3-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb3-15"><a href="#cb3-15"></a>)</span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb3-19"><a href="#cb3-19"></a>    [</span>
<span id="cb3-20"><a href="#cb3-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb3-21"><a href="#cb3-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb3-22"><a href="#cb3-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb3-23"><a href="#cb3-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb3-24"><a href="#cb3-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb3-25"><a href="#cb3-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb3-26"><a href="#cb3-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb3-27"><a href="#cb3-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb3-28"><a href="#cb3-28"></a>    ],</span>
<span id="cb3-29"><a href="#cb3-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb3-30"><a href="#cb3-30"></a>)</span>
<span id="cb3-31"><a href="#cb3-31"></a></span>
<span id="cb3-32"><a href="#cb3-32"></a><span class="co">## Create the graph</span></span>
<span id="cb3-33"><a href="#cb3-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb3-34"><a href="#cb3-34"></a></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="co">## Search from vertex with name = "Esther" to vertex with name = "Charlie"</span></span>
<span id="cb3-36"><a href="#cb3-36"></a>shortestPaths <span class="op">=</span> g.bfs(<span class="st">"name = 'Esther' "</span>, <span class="st">"name = 'Charlie' "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example 2
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li>Find the shortest path from Alice to a user who is 30 years old</li>
<li>Store the result in a DataFrame</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Example graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Resulting graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_3.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb4-5"><a href="#cb4-5"></a>    [</span>
<span id="cb4-6"><a href="#cb4-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb4-7"><a href="#cb4-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb4-8"><a href="#cb4-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb4-9"><a href="#cb4-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb4-10"><a href="#cb4-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb4-11"><a href="#cb4-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb4-12"><a href="#cb4-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb4-13"><a href="#cb4-13"></a>    ],</span>
<span id="cb4-14"><a href="#cb4-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb4-15"><a href="#cb4-15"></a>)</span>
<span id="cb4-16"><a href="#cb4-16"></a></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb4-19"><a href="#cb4-19"></a>    [</span>
<span id="cb4-20"><a href="#cb4-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb4-21"><a href="#cb4-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb4-22"><a href="#cb4-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb4-23"><a href="#cb4-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb4-24"><a href="#cb4-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb4-25"><a href="#cb4-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb4-26"><a href="#cb4-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb4-27"><a href="#cb4-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb4-28"><a href="#cb4-28"></a>    ],</span>
<span id="cb4-29"><a href="#cb4-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb4-30"><a href="#cb4-30"></a>)</span>
<span id="cb4-31"><a href="#cb4-31"></a></span>
<span id="cb4-32"><a href="#cb4-32"></a><span class="co">## Create the graph</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb4-34"><a href="#cb4-34"></a></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="co">## Find the shortest path from Alice to a user who is 30 years old</span></span>
<span id="cb4-36"><a href="#cb4-36"></a>shortestPaths <span class="op">=</span> g.bfs(<span class="st">"name = 'Alice' "</span>, <span class="st">"age= 30"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example 3
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li>Find the shortest path from any user who is less than 31 years old to any user who is more than 30 years old</li>
<li>Store the result in a DataFrame</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Example graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Resulting graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_4.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Notice that two paths are selected in this case</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb5-5"><a href="#cb5-5"></a>    [</span>
<span id="cb5-6"><a href="#cb5-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb5-7"><a href="#cb5-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb5-8"><a href="#cb5-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb5-9"><a href="#cb5-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb5-10"><a href="#cb5-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb5-11"><a href="#cb5-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb5-12"><a href="#cb5-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb5-13"><a href="#cb5-13"></a>    ],</span>
<span id="cb5-14"><a href="#cb5-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb5-15"><a href="#cb5-15"></a>)</span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb5-19"><a href="#cb5-19"></a>    [</span>
<span id="cb5-20"><a href="#cb5-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb5-21"><a href="#cb5-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb5-22"><a href="#cb5-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb5-23"><a href="#cb5-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb5-24"><a href="#cb5-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb5-25"><a href="#cb5-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb5-26"><a href="#cb5-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb5-27"><a href="#cb5-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb5-28"><a href="#cb5-28"></a>    ],</span>
<span id="cb5-29"><a href="#cb5-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb5-30"><a href="#cb5-30"></a>)</span>
<span id="cb5-31"><a href="#cb5-31"></a></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="co">## Create the graph</span></span>
<span id="cb5-33"><a href="#cb5-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb5-34"><a href="#cb5-34"></a></span>
<span id="cb5-35"><a href="#cb5-35"></a><span class="co">## Find the shortest path from any user who is less than 31 years old</span></span>
<span id="cb5-36"><a href="#cb5-36"></a><span class="co">## to any user who is more than 30 years old</span></span>
<span id="cb5-37"><a href="#cb5-37"></a>shortestPaths <span class="op">=</span> g.bfs(<span class="st">"age&lt;31"</span>, <span class="st">"age&gt;30"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example 4
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li>Find the shortest path from Alice to any user who is less than 31 years old without using follow edges</li>
<li>Store the result in a DataFrame</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Example graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Resulting graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_5.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Notice that two paths are selected in this case</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb6-5"><a href="#cb6-5"></a>    [</span>
<span id="cb6-6"><a href="#cb6-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb6-7"><a href="#cb6-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb6-8"><a href="#cb6-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb6-9"><a href="#cb6-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb6-10"><a href="#cb6-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb6-11"><a href="#cb6-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb6-12"><a href="#cb6-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb6-13"><a href="#cb6-13"></a>    ],</span>
<span id="cb6-14"><a href="#cb6-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb6-15"><a href="#cb6-15"></a>)</span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb6-19"><a href="#cb6-19"></a>    [</span>
<span id="cb6-20"><a href="#cb6-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb6-21"><a href="#cb6-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb6-22"><a href="#cb6-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb6-23"><a href="#cb6-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb6-24"><a href="#cb6-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb6-25"><a href="#cb6-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb6-26"><a href="#cb6-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb6-27"><a href="#cb6-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb6-28"><a href="#cb6-28"></a>    ],</span>
<span id="cb6-29"><a href="#cb6-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb6-30"><a href="#cb6-30"></a>)</span>
<span id="cb6-31"><a href="#cb6-31"></a></span>
<span id="cb6-32"><a href="#cb6-32"></a><span class="co">## Create the graph</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb6-34"><a href="#cb6-34"></a></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="co">## Find the shortest path from Alice to any user who is less</span></span>
<span id="cb6-36"><a href="#cb6-36"></a><span class="co">## than 31 years old without using “follow” edges</span></span>
<span id="cb6-37"><a href="#cb6-37"></a>shortestPaths <span class="op">=</span> g.bfs(<span class="st">"name = 'Alice' "</span>, <span class="st">"age&lt;31"</span>, <span class="st">"relationship&lt;&gt; 'follow' "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="shortest-path" class="level4">
<h4 class="anchored" data-anchor-id="shortest-path">Shortest path</h4>
<p>The shortest path method selects the length of the shortest path(s) from each vertex to a given set of landmark vertexes. It uses the BFS algorithm for computing the shortest paths.</p>
<section id="implementation-1" class="level5">
<h5 class="anchored" data-anchor-id="implementation-1">Implementation</h5>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>shortestPaths(landmarks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>shortestPaths(landmarks)</code> method of the GraphFrame class returns the length of the shortest path(s) from each vertex to a given set of landmarks vertexes. For each vertex, one shortest path for each landmark vertex is computed and its length is returned.</p>
<ul>
<li><code>landmarks</code>: list of IDs of landmark vertexes (e.g., <span class="math inline">\([u1, u4]\)</span>)</li>
</ul>
<p><code>shortestPaths()</code> returns a DataFrame that contains one record/row for each distinct vertex of the input graph (also for the non-connected ones). This method is characterized by the following columns</p>
<ul>
<li>one column for each attribute of the vertexes</li>
<li>distances (type map): for each landmark lm it contains one pair (ID lm: length shortest path from the vertex of the current record to lm)</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example 1
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li>Find for each user the length of the shortest path to user <span class="math inline">\(u1\)</span> (i.e., Alice)</li>
<li>Store the result in a DataFrame</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Example graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<table class="table">
<thead>
<tr class="header">
<th>Vertex</th>
<th>Distance to <span class="math inline">\(u1\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(u1\)</span></td>
<td>0</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u2\)</span></td>
<td>-</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u3\)</span></td>
<td>-</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u4\)</span></td>
<td>1</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u5\)</span></td>
<td>2</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u6\)</span></td>
<td>-</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u7\)</span></td>
<td>-</td>
</tr>
</tbody>
</table>
<p>The content of the returned DataFrame is the following</p>
<table class="table">
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
<th>age</th>
<th>distances</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(u1\)</span></td>
<td>Alice</td>
<td>34</td>
<td><span class="math inline">\([u1 \rightarrow 0]\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(u2\)</span></td>
<td>Bob</td>
<td>36</td>
<td><span class="math inline">\([\quad]\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u3\)</span></td>
<td>Charlie</td>
<td>30</td>
<td><span class="math inline">\([\quad]\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(u4\)</span></td>
<td>David</td>
<td>29</td>
<td><span class="math inline">\([u1 \rightarrow 1]\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u5\)</span></td>
<td>Esther</td>
<td>32</td>
<td><span class="math inline">\([u1 \rightarrow 2]\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(u6\)</span></td>
<td>Fanny</td>
<td>36</td>
<td><span class="math inline">\([\quad]\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u7\)</span></td>
<td>Gabby</td>
<td>60</td>
<td><span class="math inline">\([\quad]\)</span></td>
</tr>
</tbody>
</table>
<ul>
<li><span class="math inline">\([u1 \rightarrow 0]\)</span>: data type is map. It stores a set of pairs (Key: Value)</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb8-5"><a href="#cb8-5"></a>    [</span>
<span id="cb8-6"><a href="#cb8-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb8-7"><a href="#cb8-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb8-8"><a href="#cb8-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb8-9"><a href="#cb8-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb8-10"><a href="#cb8-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb8-11"><a href="#cb8-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb8-12"><a href="#cb8-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb8-13"><a href="#cb8-13"></a>    ],</span>
<span id="cb8-14"><a href="#cb8-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb8-15"><a href="#cb8-15"></a>)</span>
<span id="cb8-16"><a href="#cb8-16"></a></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb8-18"><a href="#cb8-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb8-19"><a href="#cb8-19"></a>    [</span>
<span id="cb8-20"><a href="#cb8-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb8-21"><a href="#cb8-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb8-22"><a href="#cb8-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb8-23"><a href="#cb8-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb8-24"><a href="#cb8-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb8-25"><a href="#cb8-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb8-26"><a href="#cb8-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb8-27"><a href="#cb8-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb8-28"><a href="#cb8-28"></a>    ],</span>
<span id="cb8-29"><a href="#cb8-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb8-30"><a href="#cb8-30"></a>)</span>
<span id="cb8-31"><a href="#cb8-31"></a></span>
<span id="cb8-32"><a href="#cb8-32"></a><span class="co">## Create the graph</span></span>
<span id="cb8-33"><a href="#cb8-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb8-34"><a href="#cb8-34"></a></span>
<span id="cb8-35"><a href="#cb8-35"></a><span class="co">## Find for each user the length of the shortest path to user u1</span></span>
<span id="cb8-36"><a href="#cb8-36"></a>shortestPaths <span class="op">=</span> g.shortestPaths([<span class="st">"u1"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example 2
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li>Find for each user the length of the shortest path to users <span class="math inline">\(u1\)</span> (Alice) and <span class="math inline">\(u4\)</span> (David)</li>
<li>Store the result in a DataFrame</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Example graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<table class="table">
<thead>
<tr class="header">
<th>Vertex</th>
<th>Distance to <span class="math inline">\(u1\)</span></th>
<th>Distance to <span class="math inline">\(u1\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(u1\)</span></td>
<td>0</td>
<td>2</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u2\)</span></td>
<td>-</td>
<td>-</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u3\)</span></td>
<td>-</td>
<td>-</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u4\)</span></td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u5\)</span></td>
<td>2</td>
<td>1</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u6\)</span></td>
<td>-</td>
<td>-</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u7\)</span></td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>The content of the returned DataFrame is the following</p>
<table class="table">
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
<th>age</th>
<th>distances</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(u1\)</span></td>
<td>Alice</td>
<td>34</td>
<td><span class="math inline">\([u1 \rightarrow 0, u4 \rightarrow 2]\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(u2\)</span></td>
<td>Bob</td>
<td>36</td>
<td><span class="math inline">\([\quad]\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u3\)</span></td>
<td>Charlie</td>
<td>30</td>
<td><span class="math inline">\([\quad]\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(u4\)</span></td>
<td>David</td>
<td>29</td>
<td><span class="math inline">\([u1 \rightarrow 1, u4 \rightarrow 0]\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u5\)</span></td>
<td>Esther</td>
<td>32</td>
<td><span class="math inline">\([u1 \rightarrow 2, u4 \rightarrow 1]\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(u6\)</span></td>
<td>Fanny</td>
<td>36</td>
<td><span class="math inline">\([\quad]\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u7\)</span></td>
<td>Gabby</td>
<td>60</td>
<td><span class="math inline">\([\quad]\)</span></td>
</tr>
</tbody>
</table>
<ul>
<li><span class="math inline">\([u1 \rightarrow 0]\)</span>: data type is map. It stores a set of pairs (Key: Value)</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb9-5"><a href="#cb9-5"></a>    [</span>
<span id="cb9-6"><a href="#cb9-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb9-7"><a href="#cb9-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb9-8"><a href="#cb9-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb9-9"><a href="#cb9-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb9-10"><a href="#cb9-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb9-11"><a href="#cb9-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb9-12"><a href="#cb9-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb9-13"><a href="#cb9-13"></a>    ],</span>
<span id="cb9-14"><a href="#cb9-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb9-15"><a href="#cb9-15"></a>)</span>
<span id="cb9-16"><a href="#cb9-16"></a></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb9-18"><a href="#cb9-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb9-19"><a href="#cb9-19"></a>    [</span>
<span id="cb9-20"><a href="#cb9-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb9-21"><a href="#cb9-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb9-22"><a href="#cb9-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb9-23"><a href="#cb9-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb9-24"><a href="#cb9-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb9-25"><a href="#cb9-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb9-26"><a href="#cb9-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb9-27"><a href="#cb9-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb9-28"><a href="#cb9-28"></a>    ],</span>
<span id="cb9-29"><a href="#cb9-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb9-30"><a href="#cb9-30"></a>)</span>
<span id="cb9-31"><a href="#cb9-31"></a></span>
<span id="cb9-32"><a href="#cb9-32"></a><span class="co">## Create the graph</span></span>
<span id="cb9-33"><a href="#cb9-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb9-34"><a href="#cb9-34"></a></span>
<span id="cb9-35"><a href="#cb9-35"></a><span class="co">## Find for each user the length of the shortest paths to users u1 and u4</span></span>
<span id="cb9-36"><a href="#cb9-36"></a>shortestPaths <span class="op">=</span> g.shortestPaths([<span class="st">"u1"</span>, <span class="st">"u4"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="connected-components" class="level4">
<h4 class="anchored" data-anchor-id="connected-components">Connected components</h4>
<p>A connected component of a graph is a subgraph <span class="math inline">\(sg\)</span> such that</p>
<ul>
<li>Any two vertexes in <span class="math inline">\(sg\)</span> are connected to each other by at least one path</li>
<li>The set of vertexes in <span class="math inline">\(sg\)</span> is not connected to any additional vertexes in the original graph</li>
</ul>
<p>The direction of edges is not considered.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Two connected components</figcaption>
<p><img src="images/20_graph_analytics_2/two_connected_components.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Three connected components</figcaption>
<p><img src="images/20_graph_analytics_2/three_connected_components.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>The <code>connectedComponents()</code> method of the GraphFrame class returns the connected components of the input graph. This is an expensive algorithm, and requires setting a Spark checkpoint directory.</p>
<section id="implementation-2" class="level5">
<h5 class="anchored" data-anchor-id="implementation-2">Implementation</h5>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>connectedComponents()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>connectedComponents()</code> method returns a DataFrame that contains one record/row for each distinct vertex of the input graph. It is characterized by the following columns</p>
<ul>
<li>one column for each attribute of the vertexes</li>
<li>component (type long). It is the identifier of the connected component to which the current vertex has been assigned.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Print on the stdout the number of connected components of the following graph</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Example graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Result</figcaption>
<p><img src="images/20_graph_analytics_2/connected_components_example.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Notice that The are two connected components on this graph.</p>
<p>This is the content of the DataFrame used to store the two identified connected components</p>
<table class="table">
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
<th>age</th>
<th>component</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(u6\)</span></td>
<td>Fanny</td>
<td>36</td>
<td>146028888064</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u1\)</span></td>
<td>Alice</td>
<td>34</td>
<td>146028888064</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u3\)</span></td>
<td>Charlie</td>
<td>30</td>
<td>146028888064</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u5\)</span></td>
<td>Esther</td>
<td>32</td>
<td>146028888064</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u2\)</span></td>
<td>Bob</td>
<td>36</td>
<td>146028888064</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u4\)</span></td>
<td>David</td>
<td>29</td>
<td>146028888064</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u7\)</span></td>
<td>Gabby</td>
<td>60</td>
<td>1546188226560</td>
</tr>
</tbody>
</table>
<p>Notice the “component” field</p>
<ul>
<li>“146028888064”: vertexes of the first component</li>
<li>“1546188226560”: vertexes of the second component</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb11-5"><a href="#cb11-5"></a>    [</span>
<span id="cb11-6"><a href="#cb11-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb11-7"><a href="#cb11-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb11-8"><a href="#cb11-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb11-9"><a href="#cb11-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb11-10"><a href="#cb11-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb11-11"><a href="#cb11-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb11-12"><a href="#cb11-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb11-13"><a href="#cb11-13"></a>    ],</span>
<span id="cb11-14"><a href="#cb11-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb11-15"><a href="#cb11-15"></a>)</span>
<span id="cb11-16"><a href="#cb11-16"></a></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb11-19"><a href="#cb11-19"></a>    [</span>
<span id="cb11-20"><a href="#cb11-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb11-21"><a href="#cb11-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb11-22"><a href="#cb11-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb11-23"><a href="#cb11-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb11-24"><a href="#cb11-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb11-25"><a href="#cb11-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb11-26"><a href="#cb11-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb11-27"><a href="#cb11-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb11-28"><a href="#cb11-28"></a>    ],</span>
<span id="cb11-29"><a href="#cb11-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb11-30"><a href="#cb11-30"></a>)</span>
<span id="cb11-31"><a href="#cb11-31"></a></span>
<span id="cb11-32"><a href="#cb11-32"></a><span class="co">## Create the graph</span></span>
<span id="cb11-33"><a href="#cb11-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb11-34"><a href="#cb11-34"></a></span>
<span id="cb11-35"><a href="#cb11-35"></a><span class="co">## Set checkpoint folder</span></span>
<span id="cb11-36"><a href="#cb11-36"></a>sc.setCheckpointDir(<span class="st">"tmp_ckpts"</span>)</span>
<span id="cb11-37"><a href="#cb11-37"></a></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="co">## Run the algorithm</span></span>
<span id="cb11-39"><a href="#cb11-39"></a>connComp<span class="op">=</span>g.connectedComponents()</span>
<span id="cb11-40"><a href="#cb11-40"></a></span>
<span id="cb11-41"><a href="#cb11-41"></a><span class="co">## Count the number of components</span></span>
<span id="cb11-42"><a href="#cb11-42"></a>nComp<span class="op">=</span>connComp.select(<span class="st">"component"</span>).distinct().count()</span>
<span id="cb11-43"><a href="#cb11-43"></a></span>
<span id="cb11-44"><a href="#cb11-44"></a><span class="bu">print</span>(<span class="st">"Number of connected components: "</span>, nComp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="strongly-connected-components" class="level4">
<h4 class="anchored" data-anchor-id="strongly-connected-components">Strongly connected components</h4>
<p>A directed subgraph <span class="math inline">\(sg\)</span> is called strongly connected if every vertex in <span class="math inline">\(sg\)</span> is reachable from every other vertex in <span class="math inline">\(sg\)</span>. For undirected graph, connected and strongly connected components are the same.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Three strongly connected subgraphs/components</figcaption>
<p><img src="images/20_graph_analytics_2/three_strongly_connected_components.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<section id="implementation-3" class="level5">
<h5 class="anchored" data-anchor-id="implementation-3">Implementation</h5>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>stronglyConnectedComponents()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>stronglyConnectedComponents()</code> method of the GraphFrame class returns the strongly connected components of the input graph. It is an expensive algorithm (better to run it on a cluster with yarn scheduler even with small graphs), and it requires setting a Spark checkpoint directory.</p>
<p><code>stronglyConnectedComponents()</code> returns a DataFrame that contains one record/row for each distinct vertex of the input graph. It is characterized by the following columns</p>
<ul>
<li>one column for each attribute of the vertexes</li>
<li>component (type long). It is the identifier of the strongly connected component to which the current vertex has been assigned.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Print on the stdout the number of strongly connected components of the input graph.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Example graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Resulting graph</figcaption>
<p><img src="images/20_graph_analytics_2/strongly_connected_components_example.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Notice that there are four connected components on this graph.</p>
<p>This is the content of the DataFrame used to store the identified strongly connected components</p>
<table class="table">
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
<th>age</th>
<th>component</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(u3\)</span></td>
<td>Charlie</td>
<td>30</td>
<td>146028888064</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u2\)</span></td>
<td>Bob</td>
<td>36</td>
<td>146028888064</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u1\)</span></td>
<td>Alice</td>
<td>34</td>
<td>498216206336</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u5\)</span></td>
<td>Esther</td>
<td>32</td>
<td>498216206336</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u4\)</span></td>
<td>David</td>
<td>29</td>
<td>498216206336</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u6\)</span></td>
<td>Fanny</td>
<td>36</td>
<td>1090921693184</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u7\)</span></td>
<td>Gabby</td>
<td>60</td>
<td>1546188226560</td>
</tr>
</tbody>
</table>
<p>Notice the “component” field</p>
<ul>
<li>“146028888064”: vertexes of the first strongly connected component</li>
<li>“498216206336”: vertexes of the second strongly connected component</li>
<li>“1090921693184”: vertexes of the third strongly connected component</li>
<li>“1546188226560”: vertexes of the fourth strongly connected component</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb13-5"><a href="#cb13-5"></a>    [</span>
<span id="cb13-6"><a href="#cb13-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb13-7"><a href="#cb13-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb13-8"><a href="#cb13-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb13-9"><a href="#cb13-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb13-10"><a href="#cb13-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb13-11"><a href="#cb13-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb13-12"><a href="#cb13-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb13-13"><a href="#cb13-13"></a>    ],</span>
<span id="cb13-14"><a href="#cb13-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb13-15"><a href="#cb13-15"></a>)</span>
<span id="cb13-16"><a href="#cb13-16"></a></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb13-19"><a href="#cb13-19"></a>    [</span>
<span id="cb13-20"><a href="#cb13-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb13-21"><a href="#cb13-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb13-22"><a href="#cb13-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb13-23"><a href="#cb13-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb13-24"><a href="#cb13-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb13-25"><a href="#cb13-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb13-26"><a href="#cb13-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb13-27"><a href="#cb13-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb13-28"><a href="#cb13-28"></a>    ],</span>
<span id="cb13-29"><a href="#cb13-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb13-30"><a href="#cb13-30"></a>)</span>
<span id="cb13-31"><a href="#cb13-31"></a></span>
<span id="cb13-32"><a href="#cb13-32"></a><span class="co">## Create the graph</span></span>
<span id="cb13-33"><a href="#cb13-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb13-34"><a href="#cb13-34"></a></span>
<span id="cb13-35"><a href="#cb13-35"></a><span class="co">## Set checkpoint folder</span></span>
<span id="cb13-36"><a href="#cb13-36"></a>sc.setCheckpointDir(<span class="st">"tmp_ckpts"</span>)</span>
<span id="cb13-37"><a href="#cb13-37"></a></span>
<span id="cb13-38"><a href="#cb13-38"></a><span class="co">## Run the algorithm</span></span>
<span id="cb13-39"><a href="#cb13-39"></a>strongConnComp <span class="op">=</span> g.stronglyConnectedComponents(maxIter<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-40"><a href="#cb13-40"></a></span>
<span id="cb13-41"><a href="#cb13-41"></a><span class="co">## Count the number of strongly connected components</span></span>
<span id="cb13-42"><a href="#cb13-42"></a>nComp<span class="op">=</span>strongConnComp.select(<span class="st">"component"</span>).distinct().count()</span>
<span id="cb13-43"><a href="#cb13-43"></a></span>
<span id="cb13-44"><a href="#cb13-44"></a><span class="bu">print</span>(<span class="st">"Number of strongly connected components: "</span>, nComp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="label-propagation" class="level4">
<h4 class="anchored" data-anchor-id="label-propagation">Label propagation</h4>
<p>Label Propagation is an algorithm for detecting communities in graphs. It is similar to clustering, but exploits connectivity. Convergence is not guaranteed, and also it is possible to end up with trivial solutions.</p>
<section id="the-label-propagation-algorithm" class="level5">
<h5 class="anchored" data-anchor-id="the-label-propagation-algorithm">The Label Propagation algorithm</h5>
<p>Each vertex in the network is initially assigned to its own community: at every step, vertexes send their community affiliation to all neighbors and update their state to the mode community affiliation of incoming messages.</p>
</section>
<section id="implementation-4" class="level5">
<h5 class="anchored" data-anchor-id="implementation-4">Implementation</h5>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>labelPropagation(maxIter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>labelPropagation(maxIter)</code> method of the GraphFrame class runs and returns the result of the label propagation algorithm.</p>
<ul>
<li><code>maxIter</code>: number of iterations to run</li>
</ul>
<p><code>labelPropagation()</code> returns a DataFrame that contains one record/Row for each distinct vertex of the input graph. It is characterized by the following columns</p>
<ul>
<li>one column for each attribute of the vertexes</li>
<li>label (type long). It is the identifier of the community to which the current vertex has been assigned.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Split in groups the vertexes of the graph by using the label propagation algorithm.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Example graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Notice that the result returned by one run of the algorithm. Pay attention that convergence is not guarantee, and different results may come out from different runs.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Results</figcaption>
<p><img src="images/20_graph_analytics_2/label_propagation_example.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>This is the content of the DataFrame used to store the identified communities</p>
<table class="table">
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
<th>age</th>
<th>label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(u3\)</span></td>
<td>Charlie</td>
<td>30</td>
<td>146028888064</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u4\)</span></td>
<td>David</td>
<td>29</td>
<td>498216206336</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u1\)</span></td>
<td>Alice</td>
<td>34</td>
<td>498216206336</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u5\)</span></td>
<td>Esther</td>
<td>32</td>
<td>498216206337</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u7\)</span></td>
<td>Gabby</td>
<td>60</td>
<td>1546188226560</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u2\)</span></td>
<td>Bob</td>
<td>36</td>
<td>1606317768704</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u6\)</span></td>
<td>Fanny</td>
<td>36</td>
<td>1606317768704</td>
</tr>
</tbody>
</table>
<ul>
<li>“146028888064”: vertexes of the first community</li>
<li>“498216206336”: vertexes of the second community</li>
<li>“1546188226560”: vertexes of the third community</li>
<li>“1606317768704”: vertexes of the fourth community</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb15-5"><a href="#cb15-5"></a>    [</span>
<span id="cb15-6"><a href="#cb15-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb15-7"><a href="#cb15-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb15-8"><a href="#cb15-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb15-9"><a href="#cb15-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb15-10"><a href="#cb15-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb15-11"><a href="#cb15-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb15-12"><a href="#cb15-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb15-13"><a href="#cb15-13"></a>    ],</span>
<span id="cb15-14"><a href="#cb15-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb15-15"><a href="#cb15-15"></a>)</span>
<span id="cb15-16"><a href="#cb15-16"></a></span>
<span id="cb15-17"><a href="#cb15-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb15-18"><a href="#cb15-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb15-19"><a href="#cb15-19"></a>    [</span>
<span id="cb15-20"><a href="#cb15-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb15-21"><a href="#cb15-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb15-22"><a href="#cb15-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb15-23"><a href="#cb15-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb15-24"><a href="#cb15-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb15-25"><a href="#cb15-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb15-26"><a href="#cb15-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb15-27"><a href="#cb15-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb15-28"><a href="#cb15-28"></a>    ],</span>
<span id="cb15-29"><a href="#cb15-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb15-30"><a href="#cb15-30"></a>)</span>
<span id="cb15-31"><a href="#cb15-31"></a></span>
<span id="cb15-32"><a href="#cb15-32"></a><span class="co">## Create the graph</span></span>
<span id="cb15-33"><a href="#cb15-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb15-34"><a href="#cb15-34"></a></span>
<span id="cb15-35"><a href="#cb15-35"></a><span class="co">## Run the label propagation algorithm</span></span>
<span id="cb15-36"><a href="#cb15-36"></a>labelComm <span class="op">=</span> g.labelPropagation(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="pagerank" class="level4">
<h4 class="anchored" data-anchor-id="pagerank">PageRank</h4>
<p>PageRank is the original famous algorithm used by the Google Search engine to rank vertexes (web pages) in a graph by order of importance. For the Google search engine vertexes are web pages in the World Wide Web, and edges are hyperlinks among web pages. This algorithm assigns a numerical weighting (importance) to each node.</p>
<p>It computes a likelihood that a person randomly clicking on links will arrive at any particular web page. For having a high PageRank, it is important to</p>
<ul>
<li>Have many in-links</li>
<li>Be liked by relevant pages (pages characterized by a high PageRank)</li>
</ul>
<p>The basic idea is that each link vote is proportional to the importance of its source page <span class="math inline">\(p\)</span>: if page <span class="math inline">\(p\)</span> with importance <span class="math inline">\(\text{PageRank}(p)\)</span> has <span class="math inline">\(n\)</span> out-links, each out-link gets <span class="math inline">\(\frac{\text{PageRank}(p)}{n}\)</span> votes; the importance of page <span class="math inline">\(p\)</span> is the sum of the votes on its in-links.</p>
<section id="simple-recursive-formulation" class="level5">
<h5 class="anchored" data-anchor-id="simple-recursive-formulation">Simple recursive formulation</h5>
<ul>
<li>Initialize each page rank to <span class="math inline">\(1.0\)</span>: for each <span class="math inline">\(p\)</span> in pages set <span class="math inline">\(\textbf{PageRank}(p)\)</span> to <span class="math inline">\(1.0\)</span></li>
<li>Iterate for <span class="math inline">\(max\)</span> iterations
<ol type="1">
<li>Page <span class="math inline">\(p\)</span> sends a contribution <span class="math inline">\(\frac{\textbf{PageRank}(p)}{\textbf{numOutLinks}(p)}\)</span> to its neighbors (the pages it links);</li>
<li>Update each page rank <span class="math inline">\(\textbf{PageRank}(p)\)</span> with the sum of the received contributions.</li>
</ol></li>
</ul>
</section>
<section id="random-jumps-formulation" class="level5">
<h5 class="anchored" data-anchor-id="random-jumps-formulation">Random jumps formulation</h5>
<p>The PageRank algorithm simulates the “random walk” of a user on the web. Indeed, at each step of the random walk, the random surfer has two options:</p>
<ul>
<li><p>with probability <span class="math inline">\(1-\alpha\)</span>, follow a link at random among the ones in the current page;</p></li>
<li><p>with probability <span class="math inline">\(\alpha\)</span>, jump to a random page.</p></li>
<li><p>Initialize each page rank to <span class="math inline">\(1.0\)</span>: for each <span class="math inline">\(p\)</span> in pages set <span class="math inline">\(\textbf{PageRank}(p)\)</span> to <span class="math inline">\(1.0\)</span></p></li>
<li><p>Iterate for max iterations</p>
<ol type="1">
<li>Page <span class="math inline">\(p\)</span> sends a contribution <span class="math inline">\(\frac{\textbf{PageRank}(p)}{\textbf{numOutLinks}(p)}\)</span> to its neighbors (the pages it links);</li>
<li>Update each page rank <span class="math inline">\(\textbf{PageRank}(p)\)</span> to <span class="math inline">\(\alpha + (1 - \alpha)\)</span> <strong>times</strong> the sum of the received contributions.</li>
</ol></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><span class="math inline">\(\alpha=0.15\)</span></li>
<li>Initialization: <span class="math inline">\(\forall{p}, \textbf{PageRank}(p) = 1.0\)</span></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Initialization</figcaption>
<p><img src="images/15b_pagerank/pagerank_example_0.png" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
<div id="fig-Example" class="quarto-layout-panel">
<p></p><figcaption>Figure&nbsp;25.1: Iterations</figcaption><p></p>
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Iteration #1</figcaption>
<p><img src="images/15b_pagerank/pagerank_example_1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Iteration #2</figcaption>
<p><img src="images/15b_pagerank/pagerank_example_2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Iteration #3</figcaption>
<p><img src="images/15b_pagerank/pagerank_example_3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Iteration #4</figcaption>
<p><img src="images/15b_pagerank/pagerank_example_4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Iteration #5</figcaption>
<p><img src="images/15b_pagerank/pagerank_example_5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Iteration #50</figcaption>
<p><img src="images/15b_pagerank/pagerank_example_50.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="implementation-5" class="level5">
<h5 class="anchored" data-anchor-id="implementation-5">Implementation</h5>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>pageRank(resetProbability, maxIter, tol, sourceId)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>pageRank()</code> method of the GraphFrame class runs the PageRank algorithm on the input graph.</p>
<ul>
<li><code>resetProbability</code>: probability of resetting to a random vertex (probability <span class="math inline">\(\alpha\)</span> associated with random jumps);</li>
<li><code>maxIter</code>: if set, the algorithm is run for a fixed number of iterations; this may not be set if the tol parameter is set;</li>
<li><code>tol</code>: if set, the algorithm is run until the given tolerance; this may not be set if the numIter parameter is set;</li>
<li><code>sourceId</code>: the source vertex for a personalized PageRank (optional parameter).</li>
</ul>
<p><code>pageRank()</code> returns a new GraphFrame that contains the same vertexes and edges of the input graph</p>
<ul>
<li>the vertexes of the new graph are characterized by one new attribute, called “pagerank”, that stores the PageRank of the vertexes;</li>
<li>the edges of the new graph are characterized by one new attribute, called “weight”, that stores the weight (PageRank contribution) propagated through that edge.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Apply the PageRank algorithm on the following graph and select the user associated with the highest PageRank value.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Example graph</figcaption>
<p><img src="images/20_graph_analytics_2/bfs_example_1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption class="figure-caption">Resulting graph</figcaption>
<p><img src="images/20_graph_analytics_2/pagerank_example.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb17-5"><a href="#cb17-5"></a>    [</span>
<span id="cb17-6"><a href="#cb17-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb17-7"><a href="#cb17-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb17-8"><a href="#cb17-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb17-9"><a href="#cb17-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb17-10"><a href="#cb17-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb17-11"><a href="#cb17-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb17-12"><a href="#cb17-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb17-13"><a href="#cb17-13"></a>    ],</span>
<span id="cb17-14"><a href="#cb17-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb17-15"><a href="#cb17-15"></a>)</span>
<span id="cb17-16"><a href="#cb17-16"></a></span>
<span id="cb17-17"><a href="#cb17-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb17-18"><a href="#cb17-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb17-19"><a href="#cb17-19"></a>    [</span>
<span id="cb17-20"><a href="#cb17-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb17-21"><a href="#cb17-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb17-22"><a href="#cb17-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb17-23"><a href="#cb17-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb17-24"><a href="#cb17-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb17-25"><a href="#cb17-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb17-26"><a href="#cb17-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb17-27"><a href="#cb17-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb17-28"><a href="#cb17-28"></a>    ],</span>
<span id="cb17-29"><a href="#cb17-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb17-30"><a href="#cb17-30"></a>)</span>
<span id="cb17-31"><a href="#cb17-31"></a></span>
<span id="cb17-32"><a href="#cb17-32"></a><span class="co">## Create the graph</span></span>
<span id="cb17-33"><a href="#cb17-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb17-34"><a href="#cb17-34"></a></span>
<span id="cb17-35"><a href="#cb17-35"></a><span class="co">## Run the PageRank algorithm</span></span>
<span id="cb17-36"><a href="#cb17-36"></a>pageRanks <span class="op">=</span> g.pageRank(maxIter<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb17-37"><a href="#cb17-37"></a></span>
<span id="cb17-38"><a href="#cb17-38"></a><span class="co">## Select the maximum value of PageRank</span></span>
<span id="cb17-39"><a href="#cb17-39"></a>maxPageRank <span class="op">=</span> pageRanks.vertices <span class="op">\</span></span>
<span id="cb17-40"><a href="#cb17-40"></a>    .agg({<span class="st">"pagerank"</span>:<span class="st">"max"</span>}) <span class="op">\</span></span>
<span id="cb17-41"><a href="#cb17-41"></a>    .first()[<span class="st">"max(pagerank)"</span>]</span>
<span id="cb17-42"><a href="#cb17-42"></a></span>
<span id="cb17-43"><a href="#cb17-43"></a><span class="co">## Select the user with the maximum PageRank</span></span>
<span id="cb17-44"><a href="#cb17-44"></a>pageRanks.vertices <span class="op">\</span></span>
<span id="cb17-45"><a href="#cb17-45"></a>    .<span class="bu">filter</span>(pageRanks.vertices.pagerank<span class="op">==</span>maxPageRank) <span class="op">\</span></span>
<span id="cb17-46"><a href="#cb17-46"></a>    .show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="custom-graph-algorithms" class="level4">
<h4 class="anchored" data-anchor-id="custom-graph-algorithms">Custom graph algorithms</h4>
<p>GraphFrames provides primitives for developing yourself other graph algorithms. It is based on message passing approach: the two key components are:</p>
<ul>
<li><code>aggregateMessages</code>: it sends messages between vertexes, and aggregate messages for each vertex</li>
<li>joins: it joins message aggregates with the original graph</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For each user, compute the sum of the ages of adjacent users (count many times the same adjacent user if there are many links).</p>
<p>The resulting table is</p>
<table class="table">
<thead>
<tr class="header">
<th>Vertex</th>
<th>SumAges</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(u1\)</span></td>
<td>97</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u2\)</span></td>
<td>94</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u3\)</span></td>
<td>108</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u4\)</span></td>
<td>66</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(u5\)</span></td>
<td>99</td>
</tr>
<tr class="even">
<td><span class="math inline">\(u6\)</span></td>
<td>62</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb18-2"><a href="#cb18-2"></a></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb18-5"><a href="#cb18-5"></a>    [</span>
<span id="cb18-6"><a href="#cb18-6"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb18-7"><a href="#cb18-7"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb18-8"><a href="#cb18-8"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb18-9"><a href="#cb18-9"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb18-10"><a href="#cb18-10"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb18-11"><a href="#cb18-11"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb18-12"><a href="#cb18-12"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb18-13"><a href="#cb18-13"></a>    ],</span>
<span id="cb18-14"><a href="#cb18-14"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb18-15"><a href="#cb18-15"></a>)</span>
<span id="cb18-16"><a href="#cb18-16"></a></span>
<span id="cb18-17"><a href="#cb18-17"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb18-18"><a href="#cb18-18"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb18-19"><a href="#cb18-19"></a>    [</span>
<span id="cb18-20"><a href="#cb18-20"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb18-21"><a href="#cb18-21"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb18-22"><a href="#cb18-22"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb18-23"><a href="#cb18-23"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb18-24"><a href="#cb18-24"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb18-25"><a href="#cb18-25"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb18-26"><a href="#cb18-26"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb18-27"><a href="#cb18-27"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb18-28"><a href="#cb18-28"></a>    ],</span>
<span id="cb18-29"><a href="#cb18-29"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb18-30"><a href="#cb18-30"></a>)</span>
<span id="cb18-31"><a href="#cb18-31"></a></span>
<span id="cb18-32"><a href="#cb18-32"></a><span class="co">## Create the graph</span></span>
<span id="cb18-33"><a href="#cb18-33"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb18-34"><a href="#cb18-34"></a></span>
<span id="cb18-35"><a href="#cb18-35"></a><span class="co">## For each user, sum the ages of the adjacent users</span></span>
<span id="cb18-36"><a href="#cb18-36"></a><span class="co">## Send the age of each destination of an edge to its source</span></span>
<span id="cb18-37"><a href="#cb18-37"></a>msgToSrc <span class="op">=</span> AggregateMessages.dst[<span class="st">"age"</span>]</span>
<span id="cb18-38"><a href="#cb18-38"></a></span>
<span id="cb18-39"><a href="#cb18-39"></a><span class="co">## Send the age of each source of an edge to its destination</span></span>
<span id="cb18-40"><a href="#cb18-40"></a>msgToDst <span class="op">=</span> AggregateMessages.src[<span class="st">"age"</span>]</span>
<span id="cb18-41"><a href="#cb18-41"></a></span>
<span id="cb18-42"><a href="#cb18-42"></a><span class="co">## Aggregate messages</span></span>
<span id="cb18-43"><a href="#cb18-43"></a>aggAge <span class="op">=</span> g.aggregateMessages(</span>
<span id="cb18-44"><a href="#cb18-44"></a>    <span class="bu">sum</span>(AggregateMessages.msg),</span>
<span id="cb18-45"><a href="#cb18-45"></a>    sendToSrc<span class="op">=</span>msgToSrc,</span>
<span id="cb18-46"><a href="#cb18-46"></a>    sendToDst<span class="op">=</span>msgToDst</span>
<span id="cb18-47"><a href="#cb18-47"></a>)</span>
<span id="cb18-48"><a href="#cb18-48"></a></span>
<span id="cb18-49"><a href="#cb18-49"></a><span class="co">#Show result</span></span>
<span id="cb18-50"><a href="#cb18-50"></a>aggAge.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Handle positioning of the toggle
      window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./19_graph_analytics_1.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Graph analytics in Spark</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./21_streaming_analytics.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Streaming data analytics frameworks</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb19" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu"># Graph Analytics in Spark</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="fu">## Algorithms over graphs</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>GraphFrame provides the parallel implementation of a set of state of the art algorithms for graph analytics</span>
<span id="cb19-4"><a href="#cb19-4"></a></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="ss">- </span>Breadth first search</span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="ss">- </span>Shortest paths</span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="ss">- </span>Connected components</span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="ss">- </span>Strongly connected component</span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="ss">- </span>Label propagation</span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="ss">- </span>PageRank</span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="ss">- </span>...</span>
<span id="cb19-12"><a href="#cb19-12"></a></span>
<span id="cb19-13"><a href="#cb19-13"></a>Also custom algorithms can be designed and implemented.</span>
<span id="cb19-14"><a href="#cb19-14"></a></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="fu">### Checkpoint directory</span></span>
<span id="cb19-16"><a href="#cb19-16"></a>To run some expensive algorithms, set a checkpoint directory that will store the state of the job at every iteration. This allows to continue where left off if the job crashes. Create such a folder to set the checkpoint directory with:</span>
<span id="cb19-17"><a href="#cb19-17"></a></span>
<span id="cb19-18"><a href="#cb19-18"></a><span class="in">```python</span></span>
<span id="cb19-19"><a href="#cb19-19"></a>sc.setCheckpointDir(graphframes_ckpts_dir)</span>
<span id="cb19-20"><a href="#cb19-20"></a><span class="in">```</span></span>
<span id="cb19-21"><a href="#cb19-21"></a></span>
<span id="cb19-22"><a href="#cb19-22"></a><span class="ss">- </span><span class="in">`graphframes_ckpts_dir`</span> is the new checkpoint folder directory</span>
<span id="cb19-23"><a href="#cb19-23"></a><span class="ss">- </span><span class="in">`sc`</span> is the SparkContext object (retrieve it from a SparkSession by using <span class="in">`spark.sparkContext`</span>)</span>
<span id="cb19-24"><a href="#cb19-24"></a></span>
<span id="cb19-25"><a href="#cb19-25"></a><span class="fu">### Breadth first search</span></span>
<span id="cb19-26"><a href="#cb19-26"></a>Breadth-first search (BFS) is an algorithm for traversing/searching graph data structures: it finds the shortest path(s) from one vertex (or a set of vertexes)to another vertex (or a set of vertexes). It is used in many other algorithms</span>
<span id="cb19-27"><a href="#cb19-27"></a></span>
<span id="cb19-28"><a href="#cb19-28"></a><span class="ss">- </span>Length of shortest paths</span>
<span id="cb19-29"><a href="#cb19-29"></a><span class="ss">- </span>Connected components</span>
<span id="cb19-30"><a href="#cb19-30"></a><span class="ss">- </span>...</span>
<span id="cb19-31"><a href="#cb19-31"></a></span>
<span id="cb19-32"><a href="#cb19-32"></a><span class="fu">#### Implementation</span></span>
<span id="cb19-33"><a href="#cb19-33"></a></span>
<span id="cb19-34"><a href="#cb19-34"></a><span class="in">```python</span></span>
<span id="cb19-35"><a href="#cb19-35"></a>bfs(fromExpr, toExpr, edgeFilter<span class="op">=</span><span class="va">None</span> maxPathLength<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb19-36"><a href="#cb19-36"></a><span class="in">```</span> </span>
<span id="cb19-37"><a href="#cb19-37"></a></span>
<span id="cb19-38"><a href="#cb19-38"></a>The <span class="in">`bfs()`</span> method of the GraphFrame class returns the shortest path(s) from the vertexes matching expression <span class="in">`fromExpr`</span> expression to vertexes matching expression <span class="in">`toExpr`</span>. If there are many vertexes matching <span class="in">`fromExpr`</span> and <span class="in">`toExpr`</span>, only the couple(s) with the shortest length is returned.</span>
<span id="cb19-39"><a href="#cb19-39"></a></span>
<span id="cb19-40"><a href="#cb19-40"></a><span class="ss">- </span><span class="in">`fromExpr`</span>: Spark SQL expression specifying valid starting vertexes for the execution of the BFS algorithm (e.g., to start from a specific vertex: "id = <span class="co">[</span><span class="ot">start vertex id</span><span class="co">]</span>");</span>
<span id="cb19-41"><a href="#cb19-41"></a><span class="ss">- </span><span class="in">`toExpr`</span>: Spark SQL expression specifying valid target vertexes for the BFS algorithm;</span>
<span id="cb19-42"><a href="#cb19-42"></a><span class="ss">- </span><span class="in">`maxPathLength`</span>: Limit on the length of paths (default = 10);</span>
<span id="cb19-43"><a href="#cb19-43"></a><span class="ss">- </span><span class="in">`edgeFilter`</span>: Spark SQL expression specifying edges that may be used in the search (default None).</span>
<span id="cb19-44"><a href="#cb19-44"></a></span>
<span id="cb19-45"><a href="#cb19-45"></a><span class="in">`bfs()`</span> returns a DataFrame containing the selected shortest path(s). Notice that ff multiple paths are valid and their length is equal to the shortest length, the returned DataFrame will contain one Row for each path. The number of columns of the returned DataFrame is equal to $(\text{length of the shortest path}*2).+1$.</span>
<span id="cb19-46"><a href="#cb19-46"></a></span>
<span id="cb19-47"><a href="#cb19-47"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-48"><a href="#cb19-48"></a><span class="fu">### Example 1</span></span>
<span id="cb19-49"><a href="#cb19-49"></a><span class="ss">1. </span>Find the shortest path from Esther to Charlie</span>
<span id="cb19-50"><a href="#cb19-50"></a><span class="ss">2. </span>Store the result in a DataFrame</span>
<span id="cb19-51"><a href="#cb19-51"></a></span>
<span id="cb19-52"><a href="#cb19-52"></a><span class="al">![Example graph](images/20_graph_analytics_2/bfs_example_1.png)</span>{width=80%}</span>
<span id="cb19-53"><a href="#cb19-53"></a></span>
<span id="cb19-54"><a href="#cb19-54"></a><span class="al">![Resulting graph](images/20_graph_analytics_2/bfs_example_2.png)</span>{width=80%}</span>
<span id="cb19-55"><a href="#cb19-55"></a></span>
<span id="cb19-56"><a href="#cb19-56"></a>The content of the returned DataFrame is the following</span>
<span id="cb19-57"><a href="#cb19-57"></a></span>
<span id="cb19-58"><a href="#cb19-58"></a>|from|$e0$|$v1$|$e1$|to|</span>
<span id="cb19-59"><a href="#cb19-59"></a>|-|-|-|-|-|</span>
<span id="cb19-60"><a href="#cb19-60"></a>| $<span class="co">[</span><span class="ot">u5, \text{Esther}, 32</span><span class="co">]</span>$ | $<span class="co">[</span><span class="ot">u5, u6, \text{follow}</span><span class="co">]</span>$ | $<span class="co">[</span><span class="ot">u6, \text{Fanny}, 36</span><span class="co">]</span>$ | $<span class="co">[</span><span class="ot">u6, u3, \text{follow}</span><span class="co">]</span>$ | $<span class="co">[</span><span class="ot">u3, \text{Charlie}, 30</span><span class="co">]</span>$ |</span>
<span id="cb19-61"><a href="#cb19-61"></a></span>
<span id="cb19-62"><a href="#cb19-62"></a><span class="in">```python</span></span>
<span id="cb19-63"><a href="#cb19-63"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-64"><a href="#cb19-64"></a></span>
<span id="cb19-65"><a href="#cb19-65"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-66"><a href="#cb19-66"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-67"><a href="#cb19-67"></a>    [</span>
<span id="cb19-68"><a href="#cb19-68"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-69"><a href="#cb19-69"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-70"><a href="#cb19-70"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-71"><a href="#cb19-71"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-72"><a href="#cb19-72"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-73"><a href="#cb19-73"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-74"><a href="#cb19-74"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-75"><a href="#cb19-75"></a>    ],</span>
<span id="cb19-76"><a href="#cb19-76"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-77"><a href="#cb19-77"></a>)</span>
<span id="cb19-78"><a href="#cb19-78"></a></span>
<span id="cb19-79"><a href="#cb19-79"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-80"><a href="#cb19-80"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-81"><a href="#cb19-81"></a>    [</span>
<span id="cb19-82"><a href="#cb19-82"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-83"><a href="#cb19-83"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-84"><a href="#cb19-84"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-85"><a href="#cb19-85"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-86"><a href="#cb19-86"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-87"><a href="#cb19-87"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-88"><a href="#cb19-88"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-89"><a href="#cb19-89"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-90"><a href="#cb19-90"></a>    ],</span>
<span id="cb19-91"><a href="#cb19-91"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-92"><a href="#cb19-92"></a>)</span>
<span id="cb19-93"><a href="#cb19-93"></a></span>
<span id="cb19-94"><a href="#cb19-94"></a><span class="co">## Create the graph</span></span>
<span id="cb19-95"><a href="#cb19-95"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-96"><a href="#cb19-96"></a></span>
<span id="cb19-97"><a href="#cb19-97"></a><span class="co">## Search from vertex with name = "Esther" to vertex with name = "Charlie"</span></span>
<span id="cb19-98"><a href="#cb19-98"></a>shortestPaths <span class="op">=</span> g.bfs(<span class="st">"name = 'Esther' "</span>, <span class="st">"name = 'Charlie' "</span>)</span>
<span id="cb19-99"><a href="#cb19-99"></a><span class="in">```</span></span>
<span id="cb19-100"><a href="#cb19-100"></a></span>
<span id="cb19-101"><a href="#cb19-101"></a>:::</span>
<span id="cb19-102"><a href="#cb19-102"></a></span>
<span id="cb19-103"><a href="#cb19-103"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-104"><a href="#cb19-104"></a><span class="fu">### Example 2</span></span>
<span id="cb19-105"><a href="#cb19-105"></a><span class="ss">1. </span>Find the shortest path from Alice to a user who is 30 years old</span>
<span id="cb19-106"><a href="#cb19-106"></a><span class="ss">2. </span>Store the result in a DataFrame</span>
<span id="cb19-107"><a href="#cb19-107"></a></span>
<span id="cb19-108"><a href="#cb19-108"></a><span class="al">![Example graph](images/20_graph_analytics_2/bfs_example_1.png)</span>{width=80%}</span>
<span id="cb19-109"><a href="#cb19-109"></a></span>
<span id="cb19-110"><a href="#cb19-110"></a><span class="al">![Resulting graph](images/20_graph_analytics_2/bfs_example_3.png)</span>{width=80%}</span>
<span id="cb19-111"><a href="#cb19-111"></a></span>
<span id="cb19-112"><a href="#cb19-112"></a><span class="in">```python</span></span>
<span id="cb19-113"><a href="#cb19-113"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-114"><a href="#cb19-114"></a></span>
<span id="cb19-115"><a href="#cb19-115"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-116"><a href="#cb19-116"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-117"><a href="#cb19-117"></a>    [</span>
<span id="cb19-118"><a href="#cb19-118"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-119"><a href="#cb19-119"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-120"><a href="#cb19-120"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-121"><a href="#cb19-121"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-122"><a href="#cb19-122"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-123"><a href="#cb19-123"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-124"><a href="#cb19-124"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-125"><a href="#cb19-125"></a>    ],</span>
<span id="cb19-126"><a href="#cb19-126"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-127"><a href="#cb19-127"></a>)</span>
<span id="cb19-128"><a href="#cb19-128"></a></span>
<span id="cb19-129"><a href="#cb19-129"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-130"><a href="#cb19-130"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-131"><a href="#cb19-131"></a>    [</span>
<span id="cb19-132"><a href="#cb19-132"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-133"><a href="#cb19-133"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-134"><a href="#cb19-134"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-135"><a href="#cb19-135"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-136"><a href="#cb19-136"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-137"><a href="#cb19-137"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-138"><a href="#cb19-138"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-139"><a href="#cb19-139"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-140"><a href="#cb19-140"></a>    ],</span>
<span id="cb19-141"><a href="#cb19-141"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-142"><a href="#cb19-142"></a>)</span>
<span id="cb19-143"><a href="#cb19-143"></a></span>
<span id="cb19-144"><a href="#cb19-144"></a><span class="co">## Create the graph</span></span>
<span id="cb19-145"><a href="#cb19-145"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-146"><a href="#cb19-146"></a></span>
<span id="cb19-147"><a href="#cb19-147"></a><span class="co">## Find the shortest path from Alice to a user who is 30 years old</span></span>
<span id="cb19-148"><a href="#cb19-148"></a>shortestPaths <span class="op">=</span> g.bfs(<span class="st">"name = 'Alice' "</span>, <span class="st">"age= 30"</span>)</span>
<span id="cb19-149"><a href="#cb19-149"></a><span class="in">```</span></span>
<span id="cb19-150"><a href="#cb19-150"></a></span>
<span id="cb19-151"><a href="#cb19-151"></a>:::</span>
<span id="cb19-152"><a href="#cb19-152"></a></span>
<span id="cb19-153"><a href="#cb19-153"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-154"><a href="#cb19-154"></a><span class="fu">### Example 3</span></span>
<span id="cb19-155"><a href="#cb19-155"></a><span class="ss">1. </span>Find the shortest path from any user who is less than 31 years old to any user who is more than 30 years old</span>
<span id="cb19-156"><a href="#cb19-156"></a><span class="ss">2. </span>Store the result in a DataFrame</span>
<span id="cb19-157"><a href="#cb19-157"></a></span>
<span id="cb19-158"><a href="#cb19-158"></a><span class="al">![Example graph](images/20_graph_analytics_2/bfs_example_1.png)</span>{width=80%}</span>
<span id="cb19-159"><a href="#cb19-159"></a></span>
<span id="cb19-160"><a href="#cb19-160"></a><span class="al">![Resulting graph](images/20_graph_analytics_2/bfs_example_4.png)</span>{width=80%}</span>
<span id="cb19-161"><a href="#cb19-161"></a></span>
<span id="cb19-162"><a href="#cb19-162"></a>Notice that two paths are selected in this case</span>
<span id="cb19-163"><a href="#cb19-163"></a></span>
<span id="cb19-164"><a href="#cb19-164"></a><span class="in">```python</span></span>
<span id="cb19-165"><a href="#cb19-165"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-166"><a href="#cb19-166"></a></span>
<span id="cb19-167"><a href="#cb19-167"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-168"><a href="#cb19-168"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-169"><a href="#cb19-169"></a>    [</span>
<span id="cb19-170"><a href="#cb19-170"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-171"><a href="#cb19-171"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-172"><a href="#cb19-172"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-173"><a href="#cb19-173"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-174"><a href="#cb19-174"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-175"><a href="#cb19-175"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-176"><a href="#cb19-176"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-177"><a href="#cb19-177"></a>    ],</span>
<span id="cb19-178"><a href="#cb19-178"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-179"><a href="#cb19-179"></a>)</span>
<span id="cb19-180"><a href="#cb19-180"></a></span>
<span id="cb19-181"><a href="#cb19-181"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-182"><a href="#cb19-182"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-183"><a href="#cb19-183"></a>    [</span>
<span id="cb19-184"><a href="#cb19-184"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-185"><a href="#cb19-185"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-186"><a href="#cb19-186"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-187"><a href="#cb19-187"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-188"><a href="#cb19-188"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-189"><a href="#cb19-189"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-190"><a href="#cb19-190"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-191"><a href="#cb19-191"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-192"><a href="#cb19-192"></a>    ],</span>
<span id="cb19-193"><a href="#cb19-193"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-194"><a href="#cb19-194"></a>)</span>
<span id="cb19-195"><a href="#cb19-195"></a></span>
<span id="cb19-196"><a href="#cb19-196"></a><span class="co">## Create the graph</span></span>
<span id="cb19-197"><a href="#cb19-197"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-198"><a href="#cb19-198"></a></span>
<span id="cb19-199"><a href="#cb19-199"></a><span class="co">## Find the shortest path from any user who is less than 31 years old</span></span>
<span id="cb19-200"><a href="#cb19-200"></a><span class="co">## to any user who is more than 30 years old</span></span>
<span id="cb19-201"><a href="#cb19-201"></a>shortestPaths <span class="op">=</span> g.bfs(<span class="st">"age&lt;31"</span>, <span class="st">"age&gt;30"</span>)</span>
<span id="cb19-202"><a href="#cb19-202"></a><span class="in">```</span></span>
<span id="cb19-203"><a href="#cb19-203"></a></span>
<span id="cb19-204"><a href="#cb19-204"></a>:::</span>
<span id="cb19-205"><a href="#cb19-205"></a></span>
<span id="cb19-206"><a href="#cb19-206"></a></span>
<span id="cb19-207"><a href="#cb19-207"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-208"><a href="#cb19-208"></a><span class="fu">### Example 4</span></span>
<span id="cb19-209"><a href="#cb19-209"></a><span class="ss">1. </span>Find the shortest path from Alice to any user who is less than 31 years old without using follow edges</span>
<span id="cb19-210"><a href="#cb19-210"></a><span class="ss">2. </span>Store the result in a DataFrame</span>
<span id="cb19-211"><a href="#cb19-211"></a></span>
<span id="cb19-212"><a href="#cb19-212"></a><span class="al">![Example graph](images/20_graph_analytics_2/bfs_example_1.png)</span>{width=80%}</span>
<span id="cb19-213"><a href="#cb19-213"></a></span>
<span id="cb19-214"><a href="#cb19-214"></a><span class="al">![Resulting graph](images/20_graph_analytics_2/bfs_example_5.png)</span>{width=80%}</span>
<span id="cb19-215"><a href="#cb19-215"></a></span>
<span id="cb19-216"><a href="#cb19-216"></a>Notice that two paths are selected in this case</span>
<span id="cb19-217"><a href="#cb19-217"></a></span>
<span id="cb19-218"><a href="#cb19-218"></a><span class="in">```python</span></span>
<span id="cb19-219"><a href="#cb19-219"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-220"><a href="#cb19-220"></a></span>
<span id="cb19-221"><a href="#cb19-221"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-222"><a href="#cb19-222"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-223"><a href="#cb19-223"></a>    [</span>
<span id="cb19-224"><a href="#cb19-224"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-225"><a href="#cb19-225"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-226"><a href="#cb19-226"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-227"><a href="#cb19-227"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-228"><a href="#cb19-228"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-229"><a href="#cb19-229"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-230"><a href="#cb19-230"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-231"><a href="#cb19-231"></a>    ],</span>
<span id="cb19-232"><a href="#cb19-232"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-233"><a href="#cb19-233"></a>)</span>
<span id="cb19-234"><a href="#cb19-234"></a></span>
<span id="cb19-235"><a href="#cb19-235"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-236"><a href="#cb19-236"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-237"><a href="#cb19-237"></a>    [</span>
<span id="cb19-238"><a href="#cb19-238"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-239"><a href="#cb19-239"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-240"><a href="#cb19-240"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-241"><a href="#cb19-241"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-242"><a href="#cb19-242"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-243"><a href="#cb19-243"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-244"><a href="#cb19-244"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-245"><a href="#cb19-245"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-246"><a href="#cb19-246"></a>    ],</span>
<span id="cb19-247"><a href="#cb19-247"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-248"><a href="#cb19-248"></a>)</span>
<span id="cb19-249"><a href="#cb19-249"></a></span>
<span id="cb19-250"><a href="#cb19-250"></a><span class="co">## Create the graph</span></span>
<span id="cb19-251"><a href="#cb19-251"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-252"><a href="#cb19-252"></a></span>
<span id="cb19-253"><a href="#cb19-253"></a><span class="co">## Find the shortest path from Alice to any user who is less</span></span>
<span id="cb19-254"><a href="#cb19-254"></a><span class="co">## than 31 years old without using “follow” edges</span></span>
<span id="cb19-255"><a href="#cb19-255"></a>shortestPaths <span class="op">=</span> g.bfs(<span class="st">"name = 'Alice' "</span>, <span class="st">"age&lt;31"</span>, <span class="st">"relationship&lt;&gt; 'follow' "</span>)</span>
<span id="cb19-256"><a href="#cb19-256"></a><span class="in">```</span></span>
<span id="cb19-257"><a href="#cb19-257"></a></span>
<span id="cb19-258"><a href="#cb19-258"></a>:::</span>
<span id="cb19-259"><a href="#cb19-259"></a></span>
<span id="cb19-260"><a href="#cb19-260"></a><span class="fu">### Shortest path</span></span>
<span id="cb19-261"><a href="#cb19-261"></a>The shortest path method selects the length of the shortest path(s) from each vertex to a given set of landmark vertexes. It uses the BFS algorithm for computing the shortest paths.</span>
<span id="cb19-262"><a href="#cb19-262"></a></span>
<span id="cb19-263"><a href="#cb19-263"></a><span class="fu">#### Implementation</span></span>
<span id="cb19-264"><a href="#cb19-264"></a></span>
<span id="cb19-265"><a href="#cb19-265"></a><span class="in">```python</span></span>
<span id="cb19-266"><a href="#cb19-266"></a>shortestPaths(landmarks)</span>
<span id="cb19-267"><a href="#cb19-267"></a><span class="in">```</span></span>
<span id="cb19-268"><a href="#cb19-268"></a></span>
<span id="cb19-269"><a href="#cb19-269"></a>The <span class="in">`shortestPaths(landmarks)`</span> method of the GraphFrame class returns the length of the shortest path(s) from each vertex to a given set of landmarks vertexes. For each vertex, one shortest path for each landmark vertex is computed and its length is returned. </span>
<span id="cb19-270"><a href="#cb19-270"></a></span>
<span id="cb19-271"><a href="#cb19-271"></a><span class="ss">- </span><span class="in">`landmarks`</span>: list of IDs of landmark vertexes (e.g., $<span class="co">[</span><span class="ot">u1, u4</span><span class="co">]</span>$)</span>
<span id="cb19-272"><a href="#cb19-272"></a></span>
<span id="cb19-273"><a href="#cb19-273"></a><span class="in">`shortestPaths()`</span> returns a DataFrame that contains one record/row for each distinct vertex of the input graph (also for the non-connected ones). This method is characterized by the following columns</span>
<span id="cb19-274"><a href="#cb19-274"></a></span>
<span id="cb19-275"><a href="#cb19-275"></a><span class="ss">- </span>one column for each attribute of the vertexes</span>
<span id="cb19-276"><a href="#cb19-276"></a><span class="ss">- </span>distances (type map): for each landmark lm it contains one pair (ID lm: length shortest path from the vertex of the current record to lm)</span>
<span id="cb19-277"><a href="#cb19-277"></a></span>
<span id="cb19-278"><a href="#cb19-278"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-279"><a href="#cb19-279"></a><span class="fu">### Example 1</span></span>
<span id="cb19-280"><a href="#cb19-280"></a><span class="ss">1. </span>Find for each user the length of the shortest path to user $u1$ (i.e., Alice)</span>
<span id="cb19-281"><a href="#cb19-281"></a><span class="ss">2. </span>Store the result in a DataFrame</span>
<span id="cb19-282"><a href="#cb19-282"></a></span>
<span id="cb19-283"><a href="#cb19-283"></a><span class="al">![Example graph](images/20_graph_analytics_2/bfs_example_1.png)</span>{width=80%}</span>
<span id="cb19-284"><a href="#cb19-284"></a></span>
<span id="cb19-285"><a href="#cb19-285"></a>|Vertex|Distance to $u1$|</span>
<span id="cb19-286"><a href="#cb19-286"></a>|-|-|</span>
<span id="cb19-287"><a href="#cb19-287"></a>|$u1$|0|</span>
<span id="cb19-288"><a href="#cb19-288"></a>|$u2$|-|</span>
<span id="cb19-289"><a href="#cb19-289"></a>|$u3$|-|</span>
<span id="cb19-290"><a href="#cb19-290"></a>|$u4$|1|</span>
<span id="cb19-291"><a href="#cb19-291"></a>|$u5$|2|</span>
<span id="cb19-292"><a href="#cb19-292"></a>|$u6$|-|</span>
<span id="cb19-293"><a href="#cb19-293"></a>|$u7$|-|</span>
<span id="cb19-294"><a href="#cb19-294"></a></span>
<span id="cb19-295"><a href="#cb19-295"></a>The content of the returned DataFrame is the following</span>
<span id="cb19-296"><a href="#cb19-296"></a></span>
<span id="cb19-297"><a href="#cb19-297"></a>| id | name | age | distances |</span>
<span id="cb19-298"><a href="#cb19-298"></a>|-|-|-|-|</span>
<span id="cb19-299"><a href="#cb19-299"></a>| $u1$ | Alice | 34 | $<span class="co">[</span><span class="ot">u1 \rightarrow 0</span><span class="co">]</span>$ |</span>
<span id="cb19-300"><a href="#cb19-300"></a>| $u2$ | Bob | 36 | $<span class="co">[</span><span class="ot">\quad</span><span class="co">]</span>$ |</span>
<span id="cb19-301"><a href="#cb19-301"></a>| $u3$ |Charlie | 30 | $<span class="co">[</span><span class="ot">\quad</span><span class="co">]</span>$ |</span>
<span id="cb19-302"><a href="#cb19-302"></a>| $u4$ | David | 29 | $<span class="co">[</span><span class="ot">u1 \rightarrow 1</span><span class="co">]</span>$ |</span>
<span id="cb19-303"><a href="#cb19-303"></a>| $u5$ | Esther | 32 | $<span class="co">[</span><span class="ot">u1 \rightarrow 2</span><span class="co">]</span>$ |</span>
<span id="cb19-304"><a href="#cb19-304"></a>| $u6$ | Fanny | 36 | $<span class="co">[</span><span class="ot">\quad</span><span class="co">]</span>$ |</span>
<span id="cb19-305"><a href="#cb19-305"></a>| $u7$ | Gabby | 60 | $<span class="co">[</span><span class="ot">\quad</span><span class="co">]</span>$ |</span>
<span id="cb19-306"><a href="#cb19-306"></a></span>
<span id="cb19-307"><a href="#cb19-307"></a><span class="ss">- </span>$<span class="co">[</span><span class="ot">u1 \rightarrow 0</span><span class="co">]</span>$: data type is map. It stores a set of pairs (Key: Value)</span>
<span id="cb19-308"><a href="#cb19-308"></a></span>
<span id="cb19-309"><a href="#cb19-309"></a><span class="in">```python</span></span>
<span id="cb19-310"><a href="#cb19-310"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-311"><a href="#cb19-311"></a></span>
<span id="cb19-312"><a href="#cb19-312"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-313"><a href="#cb19-313"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-314"><a href="#cb19-314"></a>    [</span>
<span id="cb19-315"><a href="#cb19-315"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-316"><a href="#cb19-316"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-317"><a href="#cb19-317"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-318"><a href="#cb19-318"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-319"><a href="#cb19-319"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-320"><a href="#cb19-320"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-321"><a href="#cb19-321"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-322"><a href="#cb19-322"></a>    ],</span>
<span id="cb19-323"><a href="#cb19-323"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-324"><a href="#cb19-324"></a>)</span>
<span id="cb19-325"><a href="#cb19-325"></a></span>
<span id="cb19-326"><a href="#cb19-326"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-327"><a href="#cb19-327"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-328"><a href="#cb19-328"></a>    [</span>
<span id="cb19-329"><a href="#cb19-329"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-330"><a href="#cb19-330"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-331"><a href="#cb19-331"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-332"><a href="#cb19-332"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-333"><a href="#cb19-333"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-334"><a href="#cb19-334"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-335"><a href="#cb19-335"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-336"><a href="#cb19-336"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-337"><a href="#cb19-337"></a>    ],</span>
<span id="cb19-338"><a href="#cb19-338"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-339"><a href="#cb19-339"></a>)</span>
<span id="cb19-340"><a href="#cb19-340"></a></span>
<span id="cb19-341"><a href="#cb19-341"></a><span class="co">## Create the graph</span></span>
<span id="cb19-342"><a href="#cb19-342"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-343"><a href="#cb19-343"></a></span>
<span id="cb19-344"><a href="#cb19-344"></a><span class="co">## Find for each user the length of the shortest path to user u1</span></span>
<span id="cb19-345"><a href="#cb19-345"></a>shortestPaths <span class="op">=</span> g.shortestPaths([<span class="st">"u1"</span>])</span>
<span id="cb19-346"><a href="#cb19-346"></a><span class="in">```</span></span>
<span id="cb19-347"><a href="#cb19-347"></a></span>
<span id="cb19-348"><a href="#cb19-348"></a>:::</span>
<span id="cb19-349"><a href="#cb19-349"></a></span>
<span id="cb19-350"><a href="#cb19-350"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-351"><a href="#cb19-351"></a><span class="fu">### Example 2</span></span>
<span id="cb19-352"><a href="#cb19-352"></a><span class="ss">1. </span>Find for each user the length of the shortest path to users $u1$ (Alice) and $u4$ (David)</span>
<span id="cb19-353"><a href="#cb19-353"></a><span class="ss">2. </span>Store the result in a DataFrame</span>
<span id="cb19-354"><a href="#cb19-354"></a></span>
<span id="cb19-355"><a href="#cb19-355"></a><span class="al">![Example graph](images/20_graph_analytics_2/bfs_example_1.png)</span>{width=80%}</span>
<span id="cb19-356"><a href="#cb19-356"></a></span>
<span id="cb19-357"><a href="#cb19-357"></a>|Vertex|Distance to $u1$|Distance to $u1$|</span>
<span id="cb19-358"><a href="#cb19-358"></a>|-|-|-|</span>
<span id="cb19-359"><a href="#cb19-359"></a>|$u1$|0|2|</span>
<span id="cb19-360"><a href="#cb19-360"></a>|$u2$|-|-|</span>
<span id="cb19-361"><a href="#cb19-361"></a>|$u3$|-|-|</span>
<span id="cb19-362"><a href="#cb19-362"></a>|$u4$|1|0|</span>
<span id="cb19-363"><a href="#cb19-363"></a>|$u5$|2|1|</span>
<span id="cb19-364"><a href="#cb19-364"></a>|$u6$|-|-|</span>
<span id="cb19-365"><a href="#cb19-365"></a>|$u7$|-|-|</span>
<span id="cb19-366"><a href="#cb19-366"></a></span>
<span id="cb19-367"><a href="#cb19-367"></a>The content of the returned DataFrame is the following</span>
<span id="cb19-368"><a href="#cb19-368"></a></span>
<span id="cb19-369"><a href="#cb19-369"></a>| id | name | age | distances |</span>
<span id="cb19-370"><a href="#cb19-370"></a>|-|-|-|-|</span>
<span id="cb19-371"><a href="#cb19-371"></a>| $u1$ | Alice | 34 | $<span class="co">[</span><span class="ot">u1 \rightarrow 0, u4 \rightarrow 2</span><span class="co">]</span>$ |</span>
<span id="cb19-372"><a href="#cb19-372"></a>| $u2$ | Bob | 36 | $<span class="co">[</span><span class="ot">\quad</span><span class="co">]</span>$ |</span>
<span id="cb19-373"><a href="#cb19-373"></a>| $u3$ |Charlie | 30 | $<span class="co">[</span><span class="ot">\quad</span><span class="co">]</span>$ |</span>
<span id="cb19-374"><a href="#cb19-374"></a>| $u4$ | David | 29 | $<span class="co">[</span><span class="ot">u1 \rightarrow 1, u4 \rightarrow 0</span><span class="co">]</span>$ |</span>
<span id="cb19-375"><a href="#cb19-375"></a>| $u5$ | Esther | 32 | $<span class="co">[</span><span class="ot">u1 \rightarrow 2, u4 \rightarrow 1</span><span class="co">]</span>$ |</span>
<span id="cb19-376"><a href="#cb19-376"></a>| $u6$ | Fanny | 36 | $<span class="co">[</span><span class="ot">\quad</span><span class="co">]</span>$ |</span>
<span id="cb19-377"><a href="#cb19-377"></a>| $u7$ | Gabby | 60 | $<span class="co">[</span><span class="ot">\quad</span><span class="co">]</span>$ |</span>
<span id="cb19-378"><a href="#cb19-378"></a></span>
<span id="cb19-379"><a href="#cb19-379"></a><span class="ss">- </span>$<span class="co">[</span><span class="ot">u1 \rightarrow 0</span><span class="co">]</span>$: data type is map. It stores a set of pairs (Key: Value)</span>
<span id="cb19-380"><a href="#cb19-380"></a></span>
<span id="cb19-381"><a href="#cb19-381"></a><span class="in">```python</span></span>
<span id="cb19-382"><a href="#cb19-382"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-383"><a href="#cb19-383"></a></span>
<span id="cb19-384"><a href="#cb19-384"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-385"><a href="#cb19-385"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-386"><a href="#cb19-386"></a>    [</span>
<span id="cb19-387"><a href="#cb19-387"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-388"><a href="#cb19-388"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-389"><a href="#cb19-389"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-390"><a href="#cb19-390"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-391"><a href="#cb19-391"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-392"><a href="#cb19-392"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-393"><a href="#cb19-393"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-394"><a href="#cb19-394"></a>    ],</span>
<span id="cb19-395"><a href="#cb19-395"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-396"><a href="#cb19-396"></a>)</span>
<span id="cb19-397"><a href="#cb19-397"></a></span>
<span id="cb19-398"><a href="#cb19-398"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-399"><a href="#cb19-399"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-400"><a href="#cb19-400"></a>    [</span>
<span id="cb19-401"><a href="#cb19-401"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-402"><a href="#cb19-402"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-403"><a href="#cb19-403"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-404"><a href="#cb19-404"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-405"><a href="#cb19-405"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-406"><a href="#cb19-406"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-407"><a href="#cb19-407"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-408"><a href="#cb19-408"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-409"><a href="#cb19-409"></a>    ],</span>
<span id="cb19-410"><a href="#cb19-410"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-411"><a href="#cb19-411"></a>)</span>
<span id="cb19-412"><a href="#cb19-412"></a></span>
<span id="cb19-413"><a href="#cb19-413"></a><span class="co">## Create the graph</span></span>
<span id="cb19-414"><a href="#cb19-414"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-415"><a href="#cb19-415"></a></span>
<span id="cb19-416"><a href="#cb19-416"></a><span class="co">## Find for each user the length of the shortest paths to users u1 and u4</span></span>
<span id="cb19-417"><a href="#cb19-417"></a>shortestPaths <span class="op">=</span> g.shortestPaths([<span class="st">"u1"</span>, <span class="st">"u4"</span>])</span>
<span id="cb19-418"><a href="#cb19-418"></a><span class="in">```</span></span>
<span id="cb19-419"><a href="#cb19-419"></a></span>
<span id="cb19-420"><a href="#cb19-420"></a>:::</span>
<span id="cb19-421"><a href="#cb19-421"></a></span>
<span id="cb19-422"><a href="#cb19-422"></a><span class="fu">### Connected components</span></span>
<span id="cb19-423"><a href="#cb19-423"></a>A connected component of a graph is a subgraph $sg$ such that</span>
<span id="cb19-424"><a href="#cb19-424"></a></span>
<span id="cb19-425"><a href="#cb19-425"></a><span class="ss">- </span>Any two vertexes in $sg$ are connected to each other by at least one path</span>
<span id="cb19-426"><a href="#cb19-426"></a><span class="ss">- </span>The set of vertexes in $sg$ is not connected to any additional vertexes in the original graph</span>
<span id="cb19-427"><a href="#cb19-427"></a></span>
<span id="cb19-428"><a href="#cb19-428"></a>The direction of edges is not considered.</span>
<span id="cb19-429"><a href="#cb19-429"></a></span>
<span id="cb19-430"><a href="#cb19-430"></a><span class="al">![Two connected components](images/20_graph_analytics_2/two_connected_components.png)</span>{width=80%}</span>
<span id="cb19-431"><a href="#cb19-431"></a></span>
<span id="cb19-432"><a href="#cb19-432"></a><span class="al">![Three connected components](images/20_graph_analytics_2/three_connected_components.png)</span>{width=80%}</span>
<span id="cb19-433"><a href="#cb19-433"></a></span>
<span id="cb19-434"><a href="#cb19-434"></a>The <span class="in">`connectedComponents()`</span> method of the GraphFrame class returns the connected components of the input graph. This is an expensive algorithm, and requires setting a Spark checkpoint directory.</span>
<span id="cb19-435"><a href="#cb19-435"></a></span>
<span id="cb19-436"><a href="#cb19-436"></a><span class="fu">#### Implementation</span></span>
<span id="cb19-437"><a href="#cb19-437"></a></span>
<span id="cb19-438"><a href="#cb19-438"></a><span class="in">```python</span></span>
<span id="cb19-439"><a href="#cb19-439"></a>connectedComponents()</span>
<span id="cb19-440"><a href="#cb19-440"></a><span class="in">```</span></span>
<span id="cb19-441"><a href="#cb19-441"></a></span>
<span id="cb19-442"><a href="#cb19-442"></a>The <span class="in">`connectedComponents()`</span> method returns a DataFrame that contains one record/row for each distinct vertex of the input graph. It is characterized by the following columns</span>
<span id="cb19-443"><a href="#cb19-443"></a></span>
<span id="cb19-444"><a href="#cb19-444"></a><span class="ss">- </span>one column for each attribute of the vertexes</span>
<span id="cb19-445"><a href="#cb19-445"></a><span class="ss">- </span>component (type long). It is the identifier of the connected component to which the current vertex has been assigned.</span>
<span id="cb19-446"><a href="#cb19-446"></a></span>
<span id="cb19-447"><a href="#cb19-447"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-448"><a href="#cb19-448"></a><span class="fu">### Example</span></span>
<span id="cb19-449"><a href="#cb19-449"></a>Print on the stdout the number of connected components of the following graph</span>
<span id="cb19-450"><a href="#cb19-450"></a></span>
<span id="cb19-451"><a href="#cb19-451"></a><span class="al">![Example graph](images/20_graph_analytics_2/bfs_example_1.png)</span>{width=80%}</span>
<span id="cb19-452"><a href="#cb19-452"></a></span>
<span id="cb19-453"><a href="#cb19-453"></a><span class="al">![Result](images/20_graph_analytics_2/connected_components_example.png)</span>{width=80%}</span>
<span id="cb19-454"><a href="#cb19-454"></a></span>
<span id="cb19-455"><a href="#cb19-455"></a>Notice that The are two connected components on this graph.</span>
<span id="cb19-456"><a href="#cb19-456"></a></span>
<span id="cb19-457"><a href="#cb19-457"></a>This is the content of the DataFrame used to store the two identified connected components</span>
<span id="cb19-458"><a href="#cb19-458"></a></span>
<span id="cb19-459"><a href="#cb19-459"></a>| id | name |age | component |</span>
<span id="cb19-460"><a href="#cb19-460"></a>|-|-|-|-|</span>
<span id="cb19-461"><a href="#cb19-461"></a>| $u6$ | Fanny | 36 | 146028888064 |</span>
<span id="cb19-462"><a href="#cb19-462"></a>| $u1$ | Alice | 34 | 146028888064 |</span>
<span id="cb19-463"><a href="#cb19-463"></a>| $u3$ |Charlie | 30 | 146028888064 |</span>
<span id="cb19-464"><a href="#cb19-464"></a>| $u5$ | Esther | 32 | 146028888064 |</span>
<span id="cb19-465"><a href="#cb19-465"></a>| $u2$ | Bob | 36 | 146028888064 |</span>
<span id="cb19-466"><a href="#cb19-466"></a>| $u4$ | David | 29 | 146028888064 |</span>
<span id="cb19-467"><a href="#cb19-467"></a>| $u7$ | Gabby | 60 | 1546188226560 |</span>
<span id="cb19-468"><a href="#cb19-468"></a></span>
<span id="cb19-469"><a href="#cb19-469"></a>Notice the "component" field</span>
<span id="cb19-470"><a href="#cb19-470"></a></span>
<span id="cb19-471"><a href="#cb19-471"></a><span class="ss">- </span>"146028888064": vertexes of the first component</span>
<span id="cb19-472"><a href="#cb19-472"></a><span class="ss">- </span>"1546188226560": vertexes of the second component</span>
<span id="cb19-473"><a href="#cb19-473"></a></span>
<span id="cb19-474"><a href="#cb19-474"></a><span class="in">```python</span></span>
<span id="cb19-475"><a href="#cb19-475"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-476"><a href="#cb19-476"></a></span>
<span id="cb19-477"><a href="#cb19-477"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-478"><a href="#cb19-478"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-479"><a href="#cb19-479"></a>    [</span>
<span id="cb19-480"><a href="#cb19-480"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-481"><a href="#cb19-481"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-482"><a href="#cb19-482"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-483"><a href="#cb19-483"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-484"><a href="#cb19-484"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-485"><a href="#cb19-485"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-486"><a href="#cb19-486"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-487"><a href="#cb19-487"></a>    ],</span>
<span id="cb19-488"><a href="#cb19-488"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-489"><a href="#cb19-489"></a>)</span>
<span id="cb19-490"><a href="#cb19-490"></a></span>
<span id="cb19-491"><a href="#cb19-491"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-492"><a href="#cb19-492"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-493"><a href="#cb19-493"></a>    [</span>
<span id="cb19-494"><a href="#cb19-494"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-495"><a href="#cb19-495"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-496"><a href="#cb19-496"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-497"><a href="#cb19-497"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-498"><a href="#cb19-498"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-499"><a href="#cb19-499"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-500"><a href="#cb19-500"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-501"><a href="#cb19-501"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-502"><a href="#cb19-502"></a>    ],</span>
<span id="cb19-503"><a href="#cb19-503"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-504"><a href="#cb19-504"></a>)</span>
<span id="cb19-505"><a href="#cb19-505"></a></span>
<span id="cb19-506"><a href="#cb19-506"></a><span class="co">## Create the graph</span></span>
<span id="cb19-507"><a href="#cb19-507"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-508"><a href="#cb19-508"></a></span>
<span id="cb19-509"><a href="#cb19-509"></a><span class="co">## Set checkpoint folder</span></span>
<span id="cb19-510"><a href="#cb19-510"></a>sc.setCheckpointDir(<span class="st">"tmp_ckpts"</span>)</span>
<span id="cb19-511"><a href="#cb19-511"></a></span>
<span id="cb19-512"><a href="#cb19-512"></a><span class="co">## Run the algorithm</span></span>
<span id="cb19-513"><a href="#cb19-513"></a>connComp<span class="op">=</span>g.connectedComponents()</span>
<span id="cb19-514"><a href="#cb19-514"></a></span>
<span id="cb19-515"><a href="#cb19-515"></a><span class="co">## Count the number of components</span></span>
<span id="cb19-516"><a href="#cb19-516"></a>nComp<span class="op">=</span>connComp.select(<span class="st">"component"</span>).distinct().count()</span>
<span id="cb19-517"><a href="#cb19-517"></a></span>
<span id="cb19-518"><a href="#cb19-518"></a><span class="bu">print</span>(<span class="st">"Number of connected components: "</span>, nComp)</span>
<span id="cb19-519"><a href="#cb19-519"></a><span class="in">```</span></span>
<span id="cb19-520"><a href="#cb19-520"></a></span>
<span id="cb19-521"><a href="#cb19-521"></a>::: </span>
<span id="cb19-522"><a href="#cb19-522"></a></span>
<span id="cb19-523"><a href="#cb19-523"></a><span class="fu">### Strongly connected components</span></span>
<span id="cb19-524"><a href="#cb19-524"></a>A directed subgraph $sg$ is called strongly connected if every vertex in $sg$ is reachable from every other vertex in $sg$. For undirected graph, connected and strongly connected components are the same.</span>
<span id="cb19-525"><a href="#cb19-525"></a></span>
<span id="cb19-526"><a href="#cb19-526"></a><span class="al">![Three strongly connected subgraphs/components](images/20_graph_analytics_2/three_strongly_connected_components.png)</span>{width=80%}</span>
<span id="cb19-527"><a href="#cb19-527"></a></span>
<span id="cb19-528"><a href="#cb19-528"></a><span class="fu">#### Implementation</span></span>
<span id="cb19-529"><a href="#cb19-529"></a></span>
<span id="cb19-530"><a href="#cb19-530"></a><span class="in">```python</span></span>
<span id="cb19-531"><a href="#cb19-531"></a>stronglyConnectedComponents()</span>
<span id="cb19-532"><a href="#cb19-532"></a><span class="in">```</span></span>
<span id="cb19-533"><a href="#cb19-533"></a></span>
<span id="cb19-534"><a href="#cb19-534"></a>The <span class="in">`stronglyConnectedComponents()`</span> method of the GraphFrame class returns the strongly connected components of the input graph. It is an expensive algorithm (better to run it on a cluster with yarn scheduler even with small graphs), and it requires setting a Spark checkpoint directory.</span>
<span id="cb19-535"><a href="#cb19-535"></a></span>
<span id="cb19-536"><a href="#cb19-536"></a><span class="in">`stronglyConnectedComponents()`</span> returns a DataFrame that contains one record/row for each distinct vertex of the input graph. It is characterized by the following columns</span>
<span id="cb19-537"><a href="#cb19-537"></a></span>
<span id="cb19-538"><a href="#cb19-538"></a><span class="ss">- </span>one column for each attribute of the vertexes</span>
<span id="cb19-539"><a href="#cb19-539"></a><span class="ss">- </span>component (type long). It is the identifier of the strongly connected component to which the current vertex has been assigned.</span>
<span id="cb19-540"><a href="#cb19-540"></a></span>
<span id="cb19-541"><a href="#cb19-541"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-542"><a href="#cb19-542"></a><span class="fu">### Example</span></span>
<span id="cb19-543"><a href="#cb19-543"></a>Print on the stdout the number of strongly connected components of the input graph.</span>
<span id="cb19-544"><a href="#cb19-544"></a></span>
<span id="cb19-545"><a href="#cb19-545"></a><span class="al">![Example graph](images/20_graph_analytics_2/bfs_example_1.png)</span>{width=80%}</span>
<span id="cb19-546"><a href="#cb19-546"></a></span>
<span id="cb19-547"><a href="#cb19-547"></a><span class="al">![Resulting graph](images/20_graph_analytics_2/strongly_connected_components_example.png)</span>{width=80%}</span>
<span id="cb19-548"><a href="#cb19-548"></a></span>
<span id="cb19-549"><a href="#cb19-549"></a>Notice that there are four connected components on this graph.</span>
<span id="cb19-550"><a href="#cb19-550"></a></span>
<span id="cb19-551"><a href="#cb19-551"></a>This is the content of the DataFrame used to store the identified strongly connected components</span>
<span id="cb19-552"><a href="#cb19-552"></a></span>
<span id="cb19-553"><a href="#cb19-553"></a>| id | name |age | component |</span>
<span id="cb19-554"><a href="#cb19-554"></a>|-|-|-|-|</span>
<span id="cb19-555"><a href="#cb19-555"></a>| $u3$ | Charlie | 30 | 146028888064 |</span>
<span id="cb19-556"><a href="#cb19-556"></a>| $u2$ | Bob | 36 | 146028888064 |</span>
<span id="cb19-557"><a href="#cb19-557"></a>| $u1$ | Alice | 34 | 498216206336 |</span>
<span id="cb19-558"><a href="#cb19-558"></a>| $u5$ | Esther | 32 | 498216206336 |</span>
<span id="cb19-559"><a href="#cb19-559"></a>| $u4$ | David | 29 | 498216206336 |</span>
<span id="cb19-560"><a href="#cb19-560"></a>| $u6$ | Fanny | 36 | 1090921693184|</span>
<span id="cb19-561"><a href="#cb19-561"></a>| $u7$ | Gabby | 60 | 1546188226560|</span>
<span id="cb19-562"><a href="#cb19-562"></a></span>
<span id="cb19-563"><a href="#cb19-563"></a>Notice the "component" field</span>
<span id="cb19-564"><a href="#cb19-564"></a></span>
<span id="cb19-565"><a href="#cb19-565"></a><span class="ss">- </span>"146028888064": vertexes of the first strongly connected component</span>
<span id="cb19-566"><a href="#cb19-566"></a><span class="ss">- </span>"498216206336": vertexes of the second strongly connected component</span>
<span id="cb19-567"><a href="#cb19-567"></a><span class="ss">- </span>"1090921693184": vertexes of the third strongly connected component</span>
<span id="cb19-568"><a href="#cb19-568"></a><span class="ss">- </span>"1546188226560": vertexes of the fourth strongly connected component</span>
<span id="cb19-569"><a href="#cb19-569"></a></span>
<span id="cb19-570"><a href="#cb19-570"></a><span class="in">```python</span></span>
<span id="cb19-571"><a href="#cb19-571"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-572"><a href="#cb19-572"></a></span>
<span id="cb19-573"><a href="#cb19-573"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-574"><a href="#cb19-574"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-575"><a href="#cb19-575"></a>    [</span>
<span id="cb19-576"><a href="#cb19-576"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-577"><a href="#cb19-577"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-578"><a href="#cb19-578"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-579"><a href="#cb19-579"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-580"><a href="#cb19-580"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-581"><a href="#cb19-581"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-582"><a href="#cb19-582"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-583"><a href="#cb19-583"></a>    ],</span>
<span id="cb19-584"><a href="#cb19-584"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-585"><a href="#cb19-585"></a>)</span>
<span id="cb19-586"><a href="#cb19-586"></a></span>
<span id="cb19-587"><a href="#cb19-587"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-588"><a href="#cb19-588"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-589"><a href="#cb19-589"></a>    [</span>
<span id="cb19-590"><a href="#cb19-590"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-591"><a href="#cb19-591"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-592"><a href="#cb19-592"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-593"><a href="#cb19-593"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-594"><a href="#cb19-594"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-595"><a href="#cb19-595"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-596"><a href="#cb19-596"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-597"><a href="#cb19-597"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-598"><a href="#cb19-598"></a>    ],</span>
<span id="cb19-599"><a href="#cb19-599"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-600"><a href="#cb19-600"></a>)</span>
<span id="cb19-601"><a href="#cb19-601"></a></span>
<span id="cb19-602"><a href="#cb19-602"></a><span class="co">## Create the graph</span></span>
<span id="cb19-603"><a href="#cb19-603"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-604"><a href="#cb19-604"></a></span>
<span id="cb19-605"><a href="#cb19-605"></a><span class="co">## Set checkpoint folder</span></span>
<span id="cb19-606"><a href="#cb19-606"></a>sc.setCheckpointDir(<span class="st">"tmp_ckpts"</span>)</span>
<span id="cb19-607"><a href="#cb19-607"></a></span>
<span id="cb19-608"><a href="#cb19-608"></a><span class="co">## Run the algorithm</span></span>
<span id="cb19-609"><a href="#cb19-609"></a>strongConnComp <span class="op">=</span> g.stronglyConnectedComponents(maxIter<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb19-610"><a href="#cb19-610"></a></span>
<span id="cb19-611"><a href="#cb19-611"></a><span class="co">## Count the number of strongly connected components</span></span>
<span id="cb19-612"><a href="#cb19-612"></a>nComp<span class="op">=</span>strongConnComp.select(<span class="st">"component"</span>).distinct().count()</span>
<span id="cb19-613"><a href="#cb19-613"></a></span>
<span id="cb19-614"><a href="#cb19-614"></a><span class="bu">print</span>(<span class="st">"Number of strongly connected components: "</span>, nComp)</span>
<span id="cb19-615"><a href="#cb19-615"></a><span class="in">```</span></span>
<span id="cb19-616"><a href="#cb19-616"></a></span>
<span id="cb19-617"><a href="#cb19-617"></a>:::</span>
<span id="cb19-618"><a href="#cb19-618"></a></span>
<span id="cb19-619"><a href="#cb19-619"></a><span class="fu">### Label propagation</span></span>
<span id="cb19-620"><a href="#cb19-620"></a>Label Propagation is an algorithm for detecting communities in graphs. It is similar to clustering, but exploits connectivity. Convergence is not guaranteed, and also it is possible to end up with trivial solutions.</span>
<span id="cb19-621"><a href="#cb19-621"></a></span>
<span id="cb19-622"><a href="#cb19-622"></a><span class="fu">#### The Label Propagation algorithm</span></span>
<span id="cb19-623"><a href="#cb19-623"></a>Each vertex in the network is initially assigned to its own community: at every step, vertexes send their community affiliation to all neighbors and update their state to the mode community affiliation of incoming messages.</span>
<span id="cb19-624"><a href="#cb19-624"></a></span>
<span id="cb19-625"><a href="#cb19-625"></a><span class="fu">#### Implementation</span></span>
<span id="cb19-626"><a href="#cb19-626"></a></span>
<span id="cb19-627"><a href="#cb19-627"></a><span class="in">```python</span></span>
<span id="cb19-628"><a href="#cb19-628"></a>labelPropagation(maxIter)</span>
<span id="cb19-629"><a href="#cb19-629"></a><span class="in">```</span></span>
<span id="cb19-630"><a href="#cb19-630"></a></span>
<span id="cb19-631"><a href="#cb19-631"></a>The <span class="in">`labelPropagation(maxIter)`</span> method of the GraphFrame class runs and returns the result of the label propagation algorithm.</span>
<span id="cb19-632"><a href="#cb19-632"></a></span>
<span id="cb19-633"><a href="#cb19-633"></a><span class="ss">- </span><span class="in">`maxIter`</span>: number of iterations to run</span>
<span id="cb19-634"><a href="#cb19-634"></a></span>
<span id="cb19-635"><a href="#cb19-635"></a><span class="in">`labelPropagation()`</span> returns a DataFrame that contains one record/Row for each distinct vertex of the input graph. It is characterized by the following columns</span>
<span id="cb19-636"><a href="#cb19-636"></a></span>
<span id="cb19-637"><a href="#cb19-637"></a><span class="ss">- </span>one column for each attribute of the vertexes</span>
<span id="cb19-638"><a href="#cb19-638"></a><span class="ss">- </span>label (type long). It is the identifier of the community to which the current vertex has been assigned.</span>
<span id="cb19-639"><a href="#cb19-639"></a></span>
<span id="cb19-640"><a href="#cb19-640"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-641"><a href="#cb19-641"></a><span class="fu">### Example</span></span>
<span id="cb19-642"><a href="#cb19-642"></a>Split in groups the vertexes of the graph by using the label propagation algorithm.</span>
<span id="cb19-643"><a href="#cb19-643"></a></span>
<span id="cb19-644"><a href="#cb19-644"></a><span class="al">![Example graph](images/20_graph_analytics_2/bfs_example_1.png)</span>{width=80%}</span>
<span id="cb19-645"><a href="#cb19-645"></a></span>
<span id="cb19-646"><a href="#cb19-646"></a>Notice that the result returned by one run of the algorithm. Pay attention that convergence is not guarantee, and different results may come out from different runs.</span>
<span id="cb19-647"><a href="#cb19-647"></a></span>
<span id="cb19-648"><a href="#cb19-648"></a><span class="al">![Results](images/20_graph_analytics_2/label_propagation_example.png)</span>{width=80%}</span>
<span id="cb19-649"><a href="#cb19-649"></a></span>
<span id="cb19-650"><a href="#cb19-650"></a>This is the content of the DataFrame used to store the identified communities</span>
<span id="cb19-651"><a href="#cb19-651"></a></span>
<span id="cb19-652"><a href="#cb19-652"></a>| id | name |age | label |</span>
<span id="cb19-653"><a href="#cb19-653"></a>|-|-|-|-|</span>
<span id="cb19-654"><a href="#cb19-654"></a>| $u3$ |Charlie | 30| 146028888064 |</span>
<span id="cb19-655"><a href="#cb19-655"></a>| $u4$ | David | 29 | 498216206336 |</span>
<span id="cb19-656"><a href="#cb19-656"></a>| $u1$ | Alice | 34 | 498216206336 |</span>
<span id="cb19-657"><a href="#cb19-657"></a>| $u5$ | Esther | 32 | 498216206337 |</span>
<span id="cb19-658"><a href="#cb19-658"></a>| $u7$ | Gabby | 60 |1546188226560|</span>
<span id="cb19-659"><a href="#cb19-659"></a>| $u2$ | Bob | 36 |1606317768704 |</span>
<span id="cb19-660"><a href="#cb19-660"></a>| $u6$ | Fanny | 36 |1606317768704 |</span>
<span id="cb19-661"><a href="#cb19-661"></a></span>
<span id="cb19-662"><a href="#cb19-662"></a><span class="ss">- </span>"146028888064": vertexes of the first community</span>
<span id="cb19-663"><a href="#cb19-663"></a><span class="ss">- </span>"498216206336": vertexes of the second community</span>
<span id="cb19-664"><a href="#cb19-664"></a><span class="ss">- </span>"1546188226560": vertexes of the third community</span>
<span id="cb19-665"><a href="#cb19-665"></a><span class="ss">- </span>"1606317768704": vertexes of the fourth community</span>
<span id="cb19-666"><a href="#cb19-666"></a></span>
<span id="cb19-667"><a href="#cb19-667"></a></span>
<span id="cb19-668"><a href="#cb19-668"></a><span class="in">```python</span></span>
<span id="cb19-669"><a href="#cb19-669"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-670"><a href="#cb19-670"></a></span>
<span id="cb19-671"><a href="#cb19-671"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-672"><a href="#cb19-672"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-673"><a href="#cb19-673"></a>    [</span>
<span id="cb19-674"><a href="#cb19-674"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-675"><a href="#cb19-675"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-676"><a href="#cb19-676"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-677"><a href="#cb19-677"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-678"><a href="#cb19-678"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-679"><a href="#cb19-679"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-680"><a href="#cb19-680"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-681"><a href="#cb19-681"></a>    ],</span>
<span id="cb19-682"><a href="#cb19-682"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-683"><a href="#cb19-683"></a>)</span>
<span id="cb19-684"><a href="#cb19-684"></a></span>
<span id="cb19-685"><a href="#cb19-685"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-686"><a href="#cb19-686"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-687"><a href="#cb19-687"></a>    [</span>
<span id="cb19-688"><a href="#cb19-688"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-689"><a href="#cb19-689"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-690"><a href="#cb19-690"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-691"><a href="#cb19-691"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-692"><a href="#cb19-692"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-693"><a href="#cb19-693"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-694"><a href="#cb19-694"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-695"><a href="#cb19-695"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-696"><a href="#cb19-696"></a>    ],</span>
<span id="cb19-697"><a href="#cb19-697"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-698"><a href="#cb19-698"></a>)</span>
<span id="cb19-699"><a href="#cb19-699"></a></span>
<span id="cb19-700"><a href="#cb19-700"></a><span class="co">## Create the graph</span></span>
<span id="cb19-701"><a href="#cb19-701"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-702"><a href="#cb19-702"></a></span>
<span id="cb19-703"><a href="#cb19-703"></a><span class="co">## Run the label propagation algorithm</span></span>
<span id="cb19-704"><a href="#cb19-704"></a>labelComm <span class="op">=</span> g.labelPropagation(<span class="dv">10</span>)</span>
<span id="cb19-705"><a href="#cb19-705"></a><span class="in">```</span></span>
<span id="cb19-706"><a href="#cb19-706"></a></span>
<span id="cb19-707"><a href="#cb19-707"></a>:::</span>
<span id="cb19-708"><a href="#cb19-708"></a></span>
<span id="cb19-709"><a href="#cb19-709"></a><span class="fu">### PageRank</span></span>
<span id="cb19-710"><a href="#cb19-710"></a>PageRank is the original famous algorithm used by the Google Search engine to rank vertexes (web pages) in a graph by order of importance. For the Google search engine vertexes are web pages in the World Wide Web, and edges are hyperlinks among web pages. This algorithm assigns a numerical weighting (importance) to each node. </span>
<span id="cb19-711"><a href="#cb19-711"></a></span>
<span id="cb19-712"><a href="#cb19-712"></a>It computes a likelihood that a person randomly clicking on links will arrive at any particular web page. For having a high PageRank, it is important to</span>
<span id="cb19-713"><a href="#cb19-713"></a></span>
<span id="cb19-714"><a href="#cb19-714"></a><span class="ss">- </span>Have many in-links</span>
<span id="cb19-715"><a href="#cb19-715"></a><span class="ss">- </span>Be liked by relevant pages (pages characterized by a high PageRank)</span>
<span id="cb19-716"><a href="#cb19-716"></a></span>
<span id="cb19-717"><a href="#cb19-717"></a>The basic idea is that each link vote is proportional to the importance of its source page $p$: if page $p$ with importance $\text{PageRank}(p)$ has $n$ out-links, each out-link gets $\frac{\text{PageRank}(p)}{n}$ votes; the importance of page $p$ is the sum of the votes on its in-links.</span>
<span id="cb19-718"><a href="#cb19-718"></a></span>
<span id="cb19-719"><a href="#cb19-719"></a><span class="fu">#### Simple recursive formulation</span></span>
<span id="cb19-720"><a href="#cb19-720"></a><span class="ss">- </span>Initialize each page rank to $1.0$: for each $p$ in pages set $\textbf{PageRank}(p)$ to $1.0$</span>
<span id="cb19-721"><a href="#cb19-721"></a><span class="ss">- </span>Iterate for $max$ iterations</span>
<span id="cb19-722"><a href="#cb19-722"></a><span class="ss">    1. </span>Page $p$ sends a contribution $\frac{\textbf{PageRank}(p)}{\textbf{numOutLinks}(p)}$ to its neighbors (the pages it links);</span>
<span id="cb19-723"><a href="#cb19-723"></a><span class="ss">    2. </span>Update each page rank $\textbf{PageRank}(p)$ with the sum of the received contributions.</span>
<span id="cb19-724"><a href="#cb19-724"></a></span>
<span id="cb19-725"><a href="#cb19-725"></a><span class="fu">#### Random jumps formulation</span></span>
<span id="cb19-726"><a href="#cb19-726"></a>The PageRank algorithm simulates the "random walk" of a user on the web. Indeed, at each step of the random walk, the random surfer has two options:</span>
<span id="cb19-727"><a href="#cb19-727"></a></span>
<span id="cb19-728"><a href="#cb19-728"></a><span class="ss">- </span>with probability $1-\alpha$, follow a link at random among the ones in the current page;</span>
<span id="cb19-729"><a href="#cb19-729"></a><span class="ss">- </span>with probability $\alpha$, jump to a random page.</span>
<span id="cb19-730"><a href="#cb19-730"></a></span>
<span id="cb19-731"><a href="#cb19-731"></a><span class="ss">- </span>Initialize each page rank to $1.0$: for each $p$ in pages set $\textbf{PageRank}(p)$ to $1.0$</span>
<span id="cb19-732"><a href="#cb19-732"></a><span class="ss">- </span>Iterate for max iterations</span>
<span id="cb19-733"><a href="#cb19-733"></a><span class="ss">    1. </span>Page $p$ sends a contribution $\frac{\textbf{PageRank}(p)}{\textbf{numOutLinks}(p)}$ to its neighbors (the pages it links);</span>
<span id="cb19-734"><a href="#cb19-734"></a><span class="ss">    2. </span>Update each page rank $\textbf{PageRank}(p)$ to $\alpha + (1 - \alpha)$ **times** the sum of the received contributions.</span>
<span id="cb19-735"><a href="#cb19-735"></a></span>
<span id="cb19-736"><a href="#cb19-736"></a>::::{.callout-note collapse="true"}</span>
<span id="cb19-737"><a href="#cb19-737"></a><span class="fu">### Example</span></span>
<span id="cb19-738"><a href="#cb19-738"></a><span class="ss">- </span>$\alpha=0.15$</span>
<span id="cb19-739"><a href="#cb19-739"></a><span class="ss">- </span>Initialization: $\forall{p}, \textbf{PageRank}(p) = 1.0$</span>
<span id="cb19-740"><a href="#cb19-740"></a></span>
<span id="cb19-741"><a href="#cb19-741"></a><span class="al">![Initialization](images/15b_pagerank/pagerank_example_0.png)</span>{width=50%}</span>
<span id="cb19-742"><a href="#cb19-742"></a></span>
<span id="cb19-743"><a href="#cb19-743"></a>::: {#fig-Example layout-ncol=2 layout-nrow=3}</span>
<span id="cb19-744"><a href="#cb19-744"></a></span>
<span id="cb19-745"><a href="#cb19-745"></a><span class="al">![Iteration #1](images/15b_pagerank/pagerank_example_1.png)</span>{width=50%}</span>
<span id="cb19-746"><a href="#cb19-746"></a></span>
<span id="cb19-747"><a href="#cb19-747"></a><span class="al">![Iteration #2](images/15b_pagerank/pagerank_example_2.png)</span>{width=50%}</span>
<span id="cb19-748"><a href="#cb19-748"></a></span>
<span id="cb19-749"><a href="#cb19-749"></a><span class="al">![Iteration #3](images/15b_pagerank/pagerank_example_3.png)</span>{width=50%}</span>
<span id="cb19-750"><a href="#cb19-750"></a></span>
<span id="cb19-751"><a href="#cb19-751"></a><span class="al">![Iteration #4](images/15b_pagerank/pagerank_example_4.png)</span>{width=50%}</span>
<span id="cb19-752"><a href="#cb19-752"></a></span>
<span id="cb19-753"><a href="#cb19-753"></a><span class="al">![Iteration #5](images/15b_pagerank/pagerank_example_5.png)</span>{width=50%}</span>
<span id="cb19-754"><a href="#cb19-754"></a></span>
<span id="cb19-755"><a href="#cb19-755"></a><span class="al">![Iteration #50](images/15b_pagerank/pagerank_example_50.png)</span>{width=50%}</span>
<span id="cb19-756"><a href="#cb19-756"></a></span>
<span id="cb19-757"><a href="#cb19-757"></a>Iterations</span>
<span id="cb19-758"><a href="#cb19-758"></a>:::</span>
<span id="cb19-759"><a href="#cb19-759"></a></span>
<span id="cb19-760"><a href="#cb19-760"></a>::::</span>
<span id="cb19-761"><a href="#cb19-761"></a></span>
<span id="cb19-762"><a href="#cb19-762"></a><span class="fu">#### Implementation </span></span>
<span id="cb19-763"><a href="#cb19-763"></a></span>
<span id="cb19-764"><a href="#cb19-764"></a><span class="in">```python</span></span>
<span id="cb19-765"><a href="#cb19-765"></a>pageRank(resetProbability, maxIter, tol, sourceId)</span>
<span id="cb19-766"><a href="#cb19-766"></a><span class="in">```</span></span>
<span id="cb19-767"><a href="#cb19-767"></a></span>
<span id="cb19-768"><a href="#cb19-768"></a>The <span class="in">`pageRank()`</span> method of the GraphFrame class runs the PageRank algorithm on the input graph.</span>
<span id="cb19-769"><a href="#cb19-769"></a></span>
<span id="cb19-770"><a href="#cb19-770"></a><span class="ss">- </span><span class="in">`resetProbability`</span>: probability of resetting to a random vertex (probability $\alpha$ associated with random jumps);</span>
<span id="cb19-771"><a href="#cb19-771"></a><span class="ss">- </span><span class="in">`maxIter`</span>: if set, the algorithm is run for a fixed number of iterations; this may not be set if the tol parameter is set;</span>
<span id="cb19-772"><a href="#cb19-772"></a><span class="ss">- </span><span class="in">`tol`</span>: if set, the algorithm is run until the given tolerance; this may not be set if the numIter parameter is set;</span>
<span id="cb19-773"><a href="#cb19-773"></a><span class="ss">- </span><span class="in">`sourceId`</span>: the source vertex for a personalized PageRank (optional parameter).</span>
<span id="cb19-774"><a href="#cb19-774"></a></span>
<span id="cb19-775"><a href="#cb19-775"></a><span class="in">`pageRank()`</span> returns a new GraphFrame that contains the same vertexes and edges of the input graph</span>
<span id="cb19-776"><a href="#cb19-776"></a></span>
<span id="cb19-777"><a href="#cb19-777"></a><span class="ss">- </span>the vertexes of the new graph are characterized by one new attribute, called "pagerank", that stores the PageRank of the vertexes;</span>
<span id="cb19-778"><a href="#cb19-778"></a><span class="ss">- </span>the edges of the new graph are characterized by one new attribute, called "weight", that stores the weight (PageRank contribution) propagated through that edge.</span>
<span id="cb19-779"><a href="#cb19-779"></a></span>
<span id="cb19-780"><a href="#cb19-780"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-781"><a href="#cb19-781"></a><span class="fu">### Example</span></span>
<span id="cb19-782"><a href="#cb19-782"></a>Apply the PageRank algorithm on the following graph and select the user associated with the highest PageRank value.</span>
<span id="cb19-783"><a href="#cb19-783"></a></span>
<span id="cb19-784"><a href="#cb19-784"></a><span class="al">![Example graph](images/20_graph_analytics_2/bfs_example_1.png)</span>{width=80%}</span>
<span id="cb19-785"><a href="#cb19-785"></a></span>
<span id="cb19-786"><a href="#cb19-786"></a><span class="al">![Resulting graph](images/20_graph_analytics_2/pagerank_example.png)</span>{width=80%}</span>
<span id="cb19-787"><a href="#cb19-787"></a></span>
<span id="cb19-788"><a href="#cb19-788"></a><span class="in">```python</span></span>
<span id="cb19-789"><a href="#cb19-789"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-790"><a href="#cb19-790"></a></span>
<span id="cb19-791"><a href="#cb19-791"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-792"><a href="#cb19-792"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-793"><a href="#cb19-793"></a>    [</span>
<span id="cb19-794"><a href="#cb19-794"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-795"><a href="#cb19-795"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-796"><a href="#cb19-796"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-797"><a href="#cb19-797"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-798"><a href="#cb19-798"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-799"><a href="#cb19-799"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-800"><a href="#cb19-800"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-801"><a href="#cb19-801"></a>    ],</span>
<span id="cb19-802"><a href="#cb19-802"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-803"><a href="#cb19-803"></a>)</span>
<span id="cb19-804"><a href="#cb19-804"></a></span>
<span id="cb19-805"><a href="#cb19-805"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-806"><a href="#cb19-806"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-807"><a href="#cb19-807"></a>    [</span>
<span id="cb19-808"><a href="#cb19-808"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-809"><a href="#cb19-809"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-810"><a href="#cb19-810"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-811"><a href="#cb19-811"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-812"><a href="#cb19-812"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-813"><a href="#cb19-813"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-814"><a href="#cb19-814"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-815"><a href="#cb19-815"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-816"><a href="#cb19-816"></a>    ],</span>
<span id="cb19-817"><a href="#cb19-817"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-818"><a href="#cb19-818"></a>)</span>
<span id="cb19-819"><a href="#cb19-819"></a></span>
<span id="cb19-820"><a href="#cb19-820"></a><span class="co">## Create the graph</span></span>
<span id="cb19-821"><a href="#cb19-821"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-822"><a href="#cb19-822"></a></span>
<span id="cb19-823"><a href="#cb19-823"></a><span class="co">## Run the PageRank algorithm</span></span>
<span id="cb19-824"><a href="#cb19-824"></a>pageRanks <span class="op">=</span> g.pageRank(maxIter<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb19-825"><a href="#cb19-825"></a></span>
<span id="cb19-826"><a href="#cb19-826"></a><span class="co">## Select the maximum value of PageRank</span></span>
<span id="cb19-827"><a href="#cb19-827"></a>maxPageRank <span class="op">=</span> pageRanks.vertices <span class="op">\</span></span>
<span id="cb19-828"><a href="#cb19-828"></a>    .agg({<span class="st">"pagerank"</span>:<span class="st">"max"</span>}) <span class="op">\</span></span>
<span id="cb19-829"><a href="#cb19-829"></a>    .first()[<span class="st">"max(pagerank)"</span>]</span>
<span id="cb19-830"><a href="#cb19-830"></a></span>
<span id="cb19-831"><a href="#cb19-831"></a><span class="co">## Select the user with the maximum PageRank</span></span>
<span id="cb19-832"><a href="#cb19-832"></a>pageRanks.vertices <span class="op">\</span></span>
<span id="cb19-833"><a href="#cb19-833"></a>    .<span class="bu">filter</span>(pageRanks.vertices.pagerank<span class="op">==</span>maxPageRank) <span class="op">\</span></span>
<span id="cb19-834"><a href="#cb19-834"></a>    .show()</span>
<span id="cb19-835"><a href="#cb19-835"></a><span class="in">```</span></span>
<span id="cb19-836"><a href="#cb19-836"></a></span>
<span id="cb19-837"><a href="#cb19-837"></a>:::</span>
<span id="cb19-838"><a href="#cb19-838"></a></span>
<span id="cb19-839"><a href="#cb19-839"></a><span class="fu">### Custom graph algorithms</span></span>
<span id="cb19-840"><a href="#cb19-840"></a>GraphFrames provides primitives for developing yourself other graph algorithms. It is based on message passing approach: the two key components are:</span>
<span id="cb19-841"><a href="#cb19-841"></a></span>
<span id="cb19-842"><a href="#cb19-842"></a><span class="ss">- </span><span class="in">`aggregateMessages`</span>: it sends messages between vertexes, and aggregate messages for each vertex</span>
<span id="cb19-843"><a href="#cb19-843"></a><span class="ss">- </span>joins: it joins message aggregates with the original graph</span>
<span id="cb19-844"><a href="#cb19-844"></a></span>
<span id="cb19-845"><a href="#cb19-845"></a>:::{.callout-note collapse="true"}</span>
<span id="cb19-846"><a href="#cb19-846"></a>For each user, compute the sum of the ages of adjacent users (count many times the same adjacent user if there are many links).</span>
<span id="cb19-847"><a href="#cb19-847"></a></span>
<span id="cb19-848"><a href="#cb19-848"></a>The resulting table is </span>
<span id="cb19-849"><a href="#cb19-849"></a></span>
<span id="cb19-850"><a href="#cb19-850"></a>| Vertex | SumAges |</span>
<span id="cb19-851"><a href="#cb19-851"></a>|-|-|</span>
<span id="cb19-852"><a href="#cb19-852"></a>|$u1$|97|</span>
<span id="cb19-853"><a href="#cb19-853"></a>|$u2$|94|</span>
<span id="cb19-854"><a href="#cb19-854"></a>|$u3$|108|</span>
<span id="cb19-855"><a href="#cb19-855"></a>|$u4$|66|</span>
<span id="cb19-856"><a href="#cb19-856"></a>|$u5$|99|</span>
<span id="cb19-857"><a href="#cb19-857"></a>|$u6$|62|</span>
<span id="cb19-858"><a href="#cb19-858"></a></span>
<span id="cb19-859"><a href="#cb19-859"></a><span class="in">```python</span></span>
<span id="cb19-860"><a href="#cb19-860"></a><span class="im">from</span> graphframes <span class="im">import</span> GraphFrame</span>
<span id="cb19-861"><a href="#cb19-861"></a></span>
<span id="cb19-862"><a href="#cb19-862"></a><span class="co">## Vertex DataFrame</span></span>
<span id="cb19-863"><a href="#cb19-863"></a>v <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-864"><a href="#cb19-864"></a>    [</span>
<span id="cb19-865"><a href="#cb19-865"></a>        (<span class="st">"u1"</span>, <span class="st">"Alice"</span>, <span class="dv">34</span>),</span>
<span id="cb19-866"><a href="#cb19-866"></a>        (<span class="st">"u2"</span>, <span class="st">"Bob"</span>, <span class="dv">36</span>),</span>
<span id="cb19-867"><a href="#cb19-867"></a>        (<span class="st">"u3"</span>, <span class="st">"Charlie"</span>, <span class="dv">30</span>),</span>
<span id="cb19-868"><a href="#cb19-868"></a>        (<span class="st">"u4"</span>, <span class="st">"David"</span>, <span class="dv">29</span>),</span>
<span id="cb19-869"><a href="#cb19-869"></a>        (<span class="st">"u5"</span>, <span class="st">"Esther"</span>, <span class="dv">32</span>),</span>
<span id="cb19-870"><a href="#cb19-870"></a>        (<span class="st">"u6"</span>, <span class="st">"Fanny"</span>, <span class="dv">36</span>),</span>
<span id="cb19-871"><a href="#cb19-871"></a>        (<span class="st">"u7"</span>, <span class="st">"Gabby"</span>, <span class="dv">60</span>)</span>
<span id="cb19-872"><a href="#cb19-872"></a>    ],</span>
<span id="cb19-873"><a href="#cb19-873"></a>    [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"age"</span>]</span>
<span id="cb19-874"><a href="#cb19-874"></a>)</span>
<span id="cb19-875"><a href="#cb19-875"></a></span>
<span id="cb19-876"><a href="#cb19-876"></a><span class="co">## Edge DataFrame</span></span>
<span id="cb19-877"><a href="#cb19-877"></a>e <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb19-878"><a href="#cb19-878"></a>    [</span>
<span id="cb19-879"><a href="#cb19-879"></a>        (<span class="st">"u1"</span>, <span class="st">"u2"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-880"><a href="#cb19-880"></a>        (<span class="st">"u2"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-881"><a href="#cb19-881"></a>        (<span class="st">"u3"</span>, <span class="st">"u2"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-882"><a href="#cb19-882"></a>        (<span class="st">"u6"</span>, <span class="st">"u3"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-883"><a href="#cb19-883"></a>        (<span class="st">"u5"</span>, <span class="st">"u6"</span>, <span class="st">"follow"</span>),</span>
<span id="cb19-884"><a href="#cb19-884"></a>        (<span class="st">"u5"</span>, <span class="st">"u4"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-885"><a href="#cb19-885"></a>        (<span class="st">"u4"</span>, <span class="st">"u1"</span>, <span class="st">"friend"</span>),</span>
<span id="cb19-886"><a href="#cb19-886"></a>        (<span class="st">"u1"</span>, <span class="st">"u5"</span>, <span class="st">"friend"</span>)</span>
<span id="cb19-887"><a href="#cb19-887"></a>    ],</span>
<span id="cb19-888"><a href="#cb19-888"></a>    [<span class="st">"src"</span>, <span class="st">"dst"</span>, <span class="st">"relationship"</span>]</span>
<span id="cb19-889"><a href="#cb19-889"></a>)</span>
<span id="cb19-890"><a href="#cb19-890"></a></span>
<span id="cb19-891"><a href="#cb19-891"></a><span class="co">## Create the graph</span></span>
<span id="cb19-892"><a href="#cb19-892"></a>g <span class="op">=</span> GraphFrame(v, e)</span>
<span id="cb19-893"><a href="#cb19-893"></a></span>
<span id="cb19-894"><a href="#cb19-894"></a><span class="co">## For each user, sum the ages of the adjacent users</span></span>
<span id="cb19-895"><a href="#cb19-895"></a><span class="co">## Send the age of each destination of an edge to its source</span></span>
<span id="cb19-896"><a href="#cb19-896"></a>msgToSrc <span class="op">=</span> AggregateMessages.dst[<span class="st">"age"</span>]</span>
<span id="cb19-897"><a href="#cb19-897"></a></span>
<span id="cb19-898"><a href="#cb19-898"></a><span class="co">## Send the age of each source of an edge to its destination</span></span>
<span id="cb19-899"><a href="#cb19-899"></a>msgToDst <span class="op">=</span> AggregateMessages.src[<span class="st">"age"</span>]</span>
<span id="cb19-900"><a href="#cb19-900"></a></span>
<span id="cb19-901"><a href="#cb19-901"></a><span class="co">## Aggregate messages</span></span>
<span id="cb19-902"><a href="#cb19-902"></a>aggAge <span class="op">=</span> g.aggregateMessages(</span>
<span id="cb19-903"><a href="#cb19-903"></a>    <span class="bu">sum</span>(AggregateMessages.msg),</span>
<span id="cb19-904"><a href="#cb19-904"></a>    sendToSrc<span class="op">=</span>msgToSrc,</span>
<span id="cb19-905"><a href="#cb19-905"></a>    sendToDst<span class="op">=</span>msgToDst</span>
<span id="cb19-906"><a href="#cb19-906"></a>)</span>
<span id="cb19-907"><a href="#cb19-907"></a></span>
<span id="cb19-908"><a href="#cb19-908"></a><span class="co">#Show result</span></span>
<span id="cb19-909"><a href="#cb19-909"></a>aggAge.show()</span>
<span id="cb19-910"><a href="#cb19-910"></a><span class="in">```</span></span>
<span id="cb19-911"><a href="#cb19-911"></a></span>
<span id="cb19-912"><a href="#cb19-912"></a>:::</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>